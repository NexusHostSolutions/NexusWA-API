<!DOCTYPE html>
<html lang="pt-br" class="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NexusWA | Enterprise Dashboard</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: { extend: { colors: { wa: { light: '#00a884', dark: '#005c4b' }, dark: { bg: '#111b21', panel: '#202c33', text: '#e9edef' } } } }
        }
    </script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: rgba(0,0,0,0.2); border-radius: 3px; }
        .dark ::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.2); }
        .fade-in { animation: fadeIn 0.2s ease-out; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .wa-notification {
            position: fixed; top: 20px; right: 20px; background: white;
            border-radius: 12px; box-shadow: 0 8px 24px rgba(0,0,0,0.15);
            padding: 16px; min-width: 300px; z-index: 9999;
            animation: slideIn 0.3s ease-out;
        }
        .dark .wa-notification { background: #2a3942; box-shadow: 0 8px 24px rgba(0,0,0,0.5); }
        @keyframes slideIn { from { transform: translateX(400px); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        .wa-notification.success { border-left: 4px solid #25d366; }
        .wa-notification.error { border-left: 4px solid #f44336; }
        .wa-notification.info { border-left: 4px solid #2196F3; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        .animate-pulse-slow { animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
        @keyframes progressStripes {
            0% { background-position: 0 0; }
            100% { background-position: 40px 0; }
        }
        .progress-striped {
            background-image: linear-gradient(45deg, rgba(255,255,255,0.15) 25%, transparent 25%, transparent 50%, rgba(255,255,255,0.15) 50%, rgba(255,255,255,0.15) 75%, transparent 75%, transparent);
            background-size: 40px 40px;
            animation: progressStripes 1s linear infinite;
        }
        .badge-admin { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .badge-user { background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); }
    </style>
</head>
<body class="bg-gray-100 text-gray-900 dark:bg-dark-bg dark:text-dark-text transition-colors duration-300">
<div id="root"></div>
<div id="notifications"></div>
<script type="text/babel">
    const { useState, useEffect, useRef } = React;
    const API_URL = "http://localhost:3001";

    const NotificationManager = {
        show: (message, type = 'info', duration = 4000) => {
            const container = document.getElementById('notifications');
            const notif = document.createElement('div');
            notif.className = `wa-notification ${type}`;
            const icon = type === 'success' ? 'âœ“' : type === 'error' ? 'âœ•' : 'â„¹';
            const color = type === 'success' ? '#25d366' : type === 'error' ? '#f44336' : '#2196F3';
            notif.innerHTML = `<div class="flex items-start gap-3"><div style="background: ${color}; color: white; width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold;">${icon}</div><div class="flex-1"><p class="font-medium text-gray-900 dark:text-white">${message}</p><p class="text-xs text-gray-500 dark:text-gray-400 mt-1">${new Date().toLocaleTimeString('pt-BR')}</p></div></div>`;
            container.appendChild(notif);
            setTimeout(() => { notif.style.animation = 'slideIn 0.3s ease-out reverse'; setTimeout(() => notif.remove(), 300); }, duration);
        }
    };

    // ============================================
    // COMPONENTES BASE
    // ============================================

    const Modal = ({ isOpen, title, onClose, children, canClose = true, size = 'md' }) => {
        if (!isOpen) return null;
        const sizeClass = size === 'lg' ? 'max-w-2xl' : size === 'xl' ? 'max-w-4xl' : 'max-w-md';
        return (
            <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/60 backdrop-blur-sm fade-in" onClick={canClose ? onClose : undefined}>
                <div className={`bg-white dark:bg-dark-panel rounded-xl shadow-2xl ${sizeClass} w-full border border-gray-200 dark:border-gray-700 relative overflow-hidden max-h-[90vh] flex flex-col`} onClick={(e) => e.stopPropagation()}>
                    <div className="flex justify-between items-center p-4 border-b border-gray-100 dark:border-gray-700 bg-gray-50 dark:bg-gray-800/50">
                        <h3 className="font-bold text-lg dark:text-white">{title}</h3>
                        {canClose && <button onClick={onClose} className="text-gray-400 hover:text-red-500"><i className="ph-bold ph-x text-lg"></i></button>}
                    </div>
                    <div className="p-6 overflow-y-auto">{children}</div>
                </div>
            </div>
        );
    };

    const Toggle = ({ label, checked, onChange, disabled = false }) => (
        <div className="flex items-center justify-between py-3 border-b border-gray-200 dark:border-gray-700 last:border-0">
            <span className="text-sm font-medium dark:text-gray-200">{label}</span>
            <label className={`relative inline-flex items-center ${disabled ? 'opacity-50 cursor-not-allowed' : 'cursor-pointer'}`}>
                <input type="checkbox" className="sr-only peer" checked={checked} onChange={(e) => !disabled && onChange(e.target.checked)} disabled={disabled} />
                <div className="w-11 h-6 bg-gray-300 peer-focus:outline-none rounded-full peer dark:bg-gray-700 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-green-600"></div>
            </label>
        </div>
    );

    const ConfirmModal = ({ isOpen, title, message, onConfirm, onCancel, confirmText = "Confirmar", cancelText = "Cancelar", type = "warning" }) => {
        if (!isOpen) return null;
        const colors = {
            warning: { bg: 'bg-orange-50 dark:bg-orange-900/20', icon: 'text-orange-600', button: 'bg-orange-600 hover:bg-orange-700' },
            danger: { bg: 'bg-red-50 dark:bg-red-900/20', icon: 'text-red-600', button: 'bg-red-600 hover:bg-red-700' },
            success: { bg: 'bg-green-50 dark:bg-green-900/20', icon: 'text-green-600', button: 'bg-green-600 hover:bg-green-700' },
            info: { bg: 'bg-blue-50 dark:bg-blue-900/20', icon: 'text-blue-600', button: 'bg-blue-600 hover:bg-blue-700' }
        };
        const color = colors[type];
        return (
            <div className="fixed inset-0 z-[100] flex items-center justify-center p-4 bg-black/60 backdrop-blur-sm fade-in" onClick={onCancel}>
                <div className="bg-white dark:bg-dark-panel rounded-xl shadow-2xl max-w-md w-full border border-gray-200 dark:border-gray-700 relative overflow-hidden" onClick={(e) => e.stopPropagation()}>
                    <div className={`p-6 ${color.bg}`}>
                        <div className="flex items-start gap-4">
                            <div className={`w-12 h-12 rounded-full flex items-center justify-center ${color.bg} ${color.icon}`}>
                                {type === 'warning' && <i className="ph-bold ph-warning text-2xl"></i>}
                                {type === 'danger' && <i className="ph-bold ph-trash text-2xl"></i>}
                                {type === 'success' && <i className="ph-bold ph-check text-2xl"></i>}
                                {type === 'info' && <i className="ph-bold ph-info text-2xl"></i>}
                            </div>
                            <div className="flex-1">
                                <h3 className="font-bold text-lg mb-2 dark:text-white">{title}</h3>
                                <p className="text-sm text-gray-600 dark:text-gray-300 whitespace-pre-line">{message}</p>
                            </div>
                        </div>
                    </div>
                    <div className="p-6 flex gap-3">
                        <button onClick={onCancel} className="flex-1 bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-white px-4 py-3 rounded-lg font-bold hover:bg-gray-300 dark:hover:bg-gray-600 transition">{cancelText}</button>
                        <button onClick={onConfirm} className={`flex-1 text-white px-4 py-3 rounded-lg font-bold transition ${color.button}`}>{confirmText}</button>
                    </div>
                </div>
            </div>
        );
    };

    const SyncModal = ({ isOpen, onClose, instanceName, syncStatus, onMinimize }) => {
        if (!isOpen) return null;
        const { syncing, phase, completed, contactsSynced, groupsSynced, dbStats, error } = syncStatus || {};
        return (
            <div className="fixed inset-0 z-[100] flex items-center justify-center p-4 bg-black/60 backdrop-blur-sm fade-in">
                <div className="bg-white dark:bg-dark-panel rounded-2xl shadow-2xl max-w-lg w-full border border-gray-200 dark:border-gray-700 relative overflow-hidden" onClick={(e) => e.stopPropagation()}>
                    <div className="bg-gradient-to-r from-green-600 to-green-500 p-6 text-white">
                        <div className="flex items-center justify-between">
                            <div className="flex items-center gap-3">
                                <div className="w-12 h-12 bg-white/20 rounded-full flex items-center justify-center">
                                    {completed ? <i className="ph-bold ph-check-circle text-3xl"></i> : <i className="ph-bold ph-arrows-clockwise text-3xl animate-spin"></i>}
                                </div>
                                <div>
                                    <h3 className="font-bold text-xl">{completed ? 'SincronizaÃ§Ã£o ConcluÃ­da!' : 'Sincronizando WhatsApp'}</h3>
                                    <p className="text-green-100 text-sm">{instanceName}</p>
                                </div>
                            </div>
                            {!syncing && <button onClick={onClose} className="text-white/80 hover:text-white"><i className="ph-bold ph-x text-xl"></i></button>}
                        </div>
                    </div>
                    <div className="p-6">
                        {error ? (
                            <div className="bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800 rounded-lg p-4 mb-4">
                                <p className="text-red-600 dark:text-red-400 font-medium"><i className="ph-bold ph-warning mr-2"></i>Erro: {error}</p>
                            </div>
                        ) : (
                            <>
                                <div className="mb-6">
                                    <div className="flex items-center gap-2 mb-2">
                                        {syncing && <i className="ph-bold ph-circle-notch animate-spin text-green-600"></i>}
                                        <span className="text-sm font-medium text-gray-600 dark:text-gray-300">{phase || (completed ? 'SincronizaÃ§Ã£o finalizada' : 'Aguardando...')}</span>
                                    </div>
                                    {syncing && <div className="w-full h-2 bg-gray-200 dark:bg-gray-700 rounded-full overflow-hidden"><div className="h-full bg-green-500 progress-striped rounded-full transition-all duration-500" style={{width: '100%'}}></div></div>}
                                </div>
                                <div className="grid grid-cols-3 gap-4 mb-6">
                                    <div className="bg-blue-50 dark:bg-blue-900/20 rounded-xl p-4 text-center border border-blue-100 dark:border-blue-800">
                                        <i className="ph-bold ph-users text-2xl text-blue-600 mb-2"></i>
                                        <p className="text-2xl font-bold text-blue-800 dark:text-blue-300">{dbStats?.contacts || 0}</p>
                                        <p className="text-xs text-blue-600 font-medium">CONTATOS</p>
                                    </div>
                                    <div className="bg-purple-50 dark:bg-purple-900/20 rounded-xl p-4 text-center border border-purple-100 dark:border-purple-800">
                                        <i className="ph-bold ph-users-three text-2xl text-purple-600 mb-2"></i>
                                        <p className="text-2xl font-bold text-purple-800 dark:text-purple-300">{dbStats?.groups || 0}</p>
                                        <p className="text-xs text-purple-600 font-medium">GRUPOS</p>
                                    </div>
                                    <div className="bg-green-50 dark:bg-green-900/20 rounded-xl p-4 text-center border border-green-100 dark:border-green-800">
                                        <i className="ph-bold ph-chat-text text-2xl text-green-600 mb-2"></i>
                                        <p className="text-2xl font-bold text-green-800 dark:text-green-300">{dbStats?.messages || 0}</p>
                                        <p className="text-xs text-green-600 font-medium">MENSAGENS</p>
                                    </div>
                                </div>
                                {syncing && <div className="bg-yellow-50 dark:bg-yellow-900/20 border border-yellow-200 dark:border-yellow-800 rounded-lg p-4 mb-4"><p className="text-sm text-yellow-800 dark:text-yellow-200"><i className="ph-bold ph-info mr-2"></i>A sincronizaÃ§Ã£o continuarÃ¡ em segundo plano.</p></div>}
                                {completed && <div className="bg-green-50 dark:bg-green-900/20 border border-green-200 dark:border-green-800 rounded-lg p-4 mb-4"><p className="text-sm text-green-800 dark:text-green-200"><i className="ph-bold ph-check-circle mr-2"></i>Todos os dados foram sincronizados!</p></div>}
                            </>
                        )}
                        <div className="flex gap-3">
                            {syncing ? (
                                <button onClick={onMinimize || onClose} className="flex-1 bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-white px-4 py-3 rounded-lg font-bold hover:bg-gray-300 dark:hover:bg-gray-600 transition flex items-center justify-center gap-2"><i className="ph-bold ph-arrows-in-simple"></i>Minimizar</button>
                            ) : (
                                <button onClick={onClose} className="flex-1 bg-green-600 text-white px-4 py-3 rounded-lg font-bold hover:bg-green-700 transition flex items-center justify-center gap-2"><i className="ph-bold ph-check"></i>{completed ? 'Concluir' : 'Fechar'}</button>
                            )}
                        </div>
                    </div>
                </div>
            </div>
        );
    };

    // ============================================
    // PÃGINA DE CONFIGURAÃ‡Ã•ES
    // ============================================

    const SettingsPage = ({ apiKey }) => {
        const [config, setConfig] = useState({ rejectCalls: false, ignoreGroups: true, alwaysOnline: false, syncHistory: false });
        const save = async () => {
            try {
                NotificationManager.show("ConfiguraÃ§Ãµes salvas!", "success");
            } catch(e) { NotificationManager.show("Erro ao salvar", "error"); }
        };
        return (
            <div className="bg-white dark:bg-dark-panel p-6 rounded-xl shadow fade-in">
                <h3 className="text-lg font-bold mb-4 dark:text-white flex items-center gap-2"><i className="ph-bold ph-gear text-2xl"></i>ConfiguraÃ§Ãµes Gerais</h3>
                <div className="space-y-1">
                    <Toggle label="Rejeitar Chamadas" checked={config.rejectCalls} onChange={v=>setConfig({...config, rejectCalls:v})} />
                    <Toggle label="Ignorar Grupos (Recomendado)" checked={config.ignoreGroups} onChange={v=>setConfig({...config, ignoreGroups:v})} />
                    <Toggle label="Sempre Online" checked={config.alwaysOnline} onChange={v=>setConfig({...config, alwaysOnline:v})} />
                    <Toggle label="Sincronizar HistÃ³rico Completo" checked={config.syncHistory} onChange={v=>setConfig({...config, syncHistory:v})} />
                </div>
                <button onClick={save} className="mt-6 bg-green-600 text-white px-6 py-3 rounded-lg font-bold w-full hover:bg-green-700 transition shadow-md flex items-center justify-center gap-2"><i className="ph-bold ph-floppy-disk text-xl"></i>Salvar AlteraÃ§Ãµes</button>
            </div>
        );
    };

    // ============================================
    // PÃGINA DE EVENTOS/WEBHOOKS
    // ============================================

    const EventsPage = ({ apiKey }) => {
        const [webhookURL, setWebhookURL] = useState('');
        const [webhookEnabled, setWebhookEnabled] = useState(false);
        const [websocketEnabled, setWebsocketEnabled] = useState(false);
        const [saving, setSaving] = useState(false);
        useEffect(() => { const saved = localStorage.getItem('nexus_webhook_config'); if(saved) { const config = JSON.parse(saved); setWebhookURL(config.url || ''); setWebhookEnabled(config.enabled || false); setWebsocketEnabled(config.websocket || false); } }, []);
        const saveWebhook = async () => {
            if(webhookEnabled && !webhookURL.trim()) { NotificationManager.show("Digite uma URL vÃ¡lida", "error"); return; }
            setSaving(true);
            try { const config = { url: webhookURL, enabled: webhookEnabled, websocket: websocketEnabled }; localStorage.setItem('nexus_webhook_config', JSON.stringify(config)); NotificationManager.show("Webhook configurado!", "success"); } catch(e) { NotificationManager.show("Erro ao salvar", "error"); } finally { setSaving(false); }
        };
        return (
            <div className="bg-white dark:bg-dark-panel p-6 rounded-xl shadow fade-in">
                <h3 className="text-lg font-bold mb-4 text-purple-600 flex items-center gap-2"><i className="ph-fill ph-broadcast text-2xl"></i>Webhooks & Eventos</h3>
                <div className="mb-4">
                    <label className="text-xs font-bold uppercase text-gray-500 dark:text-gray-400 block mb-2">URL do Webhook</label>
                    <input type="url" value={webhookURL} onChange={(e) => setWebhookURL(e.target.value)} className="w-full p-3 border rounded-lg dark:bg-gray-800 dark:border-gray-600 dark:text-white" placeholder="https://seu-sistema.com/webhook" />
                </div>
                <div className="space-y-3 mb-4">
                    <Toggle label="Ativar Webhook" checked={webhookEnabled} onChange={setWebhookEnabled} />
                    <Toggle label="Ativar WebSocket" checked={websocketEnabled} onChange={setWebsocketEnabled} />
                </div>
                <button onClick={saveWebhook} disabled={saving} className="w-full bg-purple-600 text-white px-6 py-3 rounded-lg font-bold hover:bg-purple-700 transition disabled:opacity-50 flex items-center justify-center gap-2">{saving ? <><i className="ph-bold ph-circle-notch animate-spin"></i>Salvando...</> : <><i className="ph-bold ph-floppy-disk"></i>Salvar Webhook</>}</button>
            </div>
        );
    };

    // ============================================
    // PÃGINA DE INTEGRAÃ‡Ã•ES
    // ============================================

    const IntegrationsPage = () => {
        const [selectedIntegration, setSelectedIntegration] = useState(null);
        const [integrations, setIntegrations] = useState({ typebot: { enabled: false, url: '', config: '' }, chatwoot: { enabled: false, accountId: '', token: '', url: '' }, openai: { enabled: false, apiKey: '', model: 'gpt-4' }, n8n: { enabled: false, webhookUrl: '' }, dify: { enabled: false, apiKey: '', url: '' }, flowise: { enabled: false, apiKey: '', url: '' } });
        useEffect(() => { const saved = localStorage.getItem('nexus_integrations'); if(saved) setIntegrations(JSON.parse(saved)); }, []);
        const saveIntegration = (name, config) => { const updated = { ...integrations, [name]: config }; setIntegrations(updated); localStorage.setItem('nexus_integrations', JSON.stringify(updated)); NotificationManager.show(`${name.toUpperCase()} configurado!`, "success"); setSelectedIntegration(null); };
        const integrationsList = [ { name: 'typebot', icon: 'ðŸ¤–', title: 'Typebot', description: 'Chatbot inteligente' }, { name: 'chatwoot', icon: 'ðŸ’¬', title: 'Chatwoot', description: 'Atendimento multicanal' }, { name: 'openai', icon: 'ðŸ§ ', title: 'OpenAI', description: 'InteligÃªncia artificial' }, { name: 'n8n', icon: 'âš¡', title: 'n8n', description: 'AutomaÃ§Ã£o de workflows' }, { name: 'dify', icon: 'ðŸš€', title: 'Dify', description: 'LLM Application' }, { name: 'flowise', icon: 'ðŸŒŠ', title: 'Flowise', description: 'LLM Orchestration' } ];
        return (
            <>
                <div className="grid grid-cols-1 md:grid-cols-3 gap-4 fade-in">
                    {integrationsList.map(int => (
                        <div key={int.name} onClick={() => setSelectedIntegration(int.name)} className="bg-white dark:bg-dark-panel p-6 rounded-xl shadow border border-gray-200 dark:border-gray-700 hover:border-green-500 hover:shadow-lg transition cursor-pointer group">
                            <div className="flex justify-between items-start mb-3"><div className="text-4xl">{int.icon}</div><div className={`w-3 h-3 rounded-full ${integrations[int.name]?.enabled ? 'bg-green-500' : 'bg-red-500'}`}></div></div>
                            <h4 className="font-bold text-lg dark:text-white mb-1">{int.title}</h4>
                            <p className="text-xs text-gray-500 mb-3">{int.description}</p>
                            <div className="flex items-center gap-2 text-green-600 group-hover:text-green-700 font-medium text-sm"><i className="ph-bold ph-gear"></i><span>Configurar</span></div>
                        </div>
                    ))}
                </div>
                {selectedIntegration && <Modal isOpen={true} title={`Configurar ${selectedIntegration.toUpperCase()}`} onClose={() => setSelectedIntegration(null)}><IntegrationConfig name={selectedIntegration} config={integrations[selectedIntegration]} onSave={saveIntegration} onClose={() => setSelectedIntegration(null)} /></Modal>}
            </>
        );
    };

    const IntegrationConfig = ({ name, config, onSave, onClose }) => {
        const [formData, setFormData] = useState(config);
        const handleSave = () => { onSave(name, formData); };
        const renderFields = () => {
            switch(name) {
                case 'typebot': return <><input type="url" placeholder="URL do Typebot" value={formData.url || ''} onChange={(e) => setFormData({...formData, url: e.target.value})} className="w-full p-3 border rounded mb-3 dark:bg-gray-700 dark:text-white" /><input type="text" placeholder="ID da ConfiguraÃ§Ã£o" value={formData.config || ''} onChange={(e) => setFormData({...formData, config: e.target.value})} className="w-full p-3 border rounded mb-3 dark:bg-gray-700 dark:text-white" /></>;
                case 'chatwoot': return <><input type="url" placeholder="URL do Chatwoot" value={formData.url || ''} onChange={(e) => setFormData({...formData, url: e.target.value})} className="w-full p-3 border rounded mb-3 dark:bg-gray-700 dark:text-white" /><input type="text" placeholder="Account ID" value={formData.accountId || ''} onChange={(e) => setFormData({...formData, accountId: e.target.value})} className="w-full p-3 border rounded mb-3 dark:bg-gray-700 dark:text-white" /><input type="password" placeholder="Token" value={formData.token || ''} onChange={(e) => setFormData({...formData, token: e.target.value})} className="w-full p-3 border rounded mb-3 dark:bg-gray-700 dark:text-white" /></>;
                case 'openai': return <><input type="password" placeholder="API Key OpenAI" value={formData.apiKey || ''} onChange={(e) => setFormData({...formData, apiKey: e.target.value})} className="w-full p-3 border rounded mb-3 dark:bg-gray-700 dark:text-white" /><select value={formData.model || 'gpt-4'} onChange={(e) => setFormData({...formData, model: e.target.value})} className="w-full p-3 border rounded mb-3 dark:bg-gray-700 dark:text-white"><option value="gpt-4">GPT-4</option><option value="gpt-4-turbo">GPT-4 Turbo</option><option value="gpt-3.5-turbo">GPT-3.5 Turbo</option></select></>;
                case 'n8n': return <input type="url" placeholder="Webhook URL n8n" value={formData.webhookUrl || ''} onChange={(e) => setFormData({...formData, webhookUrl: e.target.value})} className="w-full p-3 border rounded mb-3 dark:bg-gray-700 dark:text-white" />;
                default: return <><input type="url" placeholder={`URL do ${name}`} value={formData.url || ''} onChange={(e) => setFormData({...formData, url: e.target.value})} className="w-full p-3 border rounded mb-3 dark:bg-gray-700 dark:text-white" /><input type="password" placeholder="API Key" value={formData.apiKey || ''} onChange={(e) => setFormData({...formData, apiKey: e.target.value})} className="w-full p-3 border rounded mb-3 dark:bg-gray-700 dark:text-white" /></>;
            }
        };
        return (
            <div>
                <div className="mb-4"><Toggle label="Ativar IntegraÃ§Ã£o" checked={formData.enabled || false} onChange={(v) => setFormData({...formData, enabled: v})} /></div>
                {formData.enabled && <div className="mb-4">{renderFields()}</div>}
                <div className="flex gap-2"><button onClick={handleSave} className="flex-1 bg-green-600 text-white py-2 rounded font-bold hover:bg-green-700">Salvar</button><button onClick={onClose} className="px-6 bg-gray-200 dark:bg-gray-700 py-2 rounded font-bold hover:bg-gray-300 dark:hover:bg-gray-600">Cancelar</button></div>
            </div>
        );
    };

    // ============================================
    // PÃGINA DE GERENCIAMENTO DE API KEYS
    // ============================================

    const ApiKeysPage = ({ apiKey, isSuperAdmin, instances }) => {
        const [keys, setKeys] = useState([]);
        const [loading, setLoading] = useState(true);
        const [showCreateModal, setShowCreateModal] = useState(false);
        const [generatedKey, setGeneratedKey] = useState(null);
        const [editingKey, setEditingKey] = useState(null);
        
        // Form state
        const [newKeyName, setNewKeyName] = useState('');
        const [newKeyTipo, setNewKeyTipo] = useState('user');
        const [newKeyValidade, setNewKeyValidade] = useState('never');
        const [newKeyInstancias, setNewKeyInstancias] = useState([]);

        const loadKeys = async () => {
            setLoading(true);
            try {
                const res = await fetch(`${API_URL}/v1/api-keys`, { headers: { 'apikey': apiKey } });
                if (res.ok) {
                    const data = await res.json();
                    setKeys(data);
                } else {
                    NotificationManager.show("Erro ao carregar API Keys", "error");
                }
            } catch (e) {
                NotificationManager.show("Erro de conexÃ£o", "error");
            } finally {
                setLoading(false);
            }
        };

        useEffect(() => {
            if (isSuperAdmin) loadKeys();
        }, [isSuperAdmin]);

        const createKey = async () => {
            if (!newKeyName.trim()) {
                NotificationManager.show("Digite um nome para a API Key", "error");
                return;
            }

            try {
                const res = await fetch(`${API_URL}/v1/api-keys`, {
                    method: 'POST',
                    headers: { 'apikey': apiKey, 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        nome: newKeyName,
                        tipo: newKeyTipo,
                        validade: newKeyValidade === 'never' ? null : newKeyValidade,
                        instanciasPermitidas: newKeyTipo === 'user' ? newKeyInstancias : null
                    })
                });

                if (res.ok) {
                    const data = await res.json();
                    setGeneratedKey(data.apiKey);
                    setShowCreateModal(false);
                    setNewKeyName('');
                    setNewKeyTipo('user');
                    setNewKeyValidade('never');
                    setNewKeyInstancias([]);
                    loadKeys();
                    NotificationManager.show("API Key criada com sucesso!", "success");
                } else {
                    const error = await res.json();
                    NotificationManager.show(error.error || "Erro ao criar", "error");
                }
            } catch (e) {
                NotificationManager.show("Erro de conexÃ£o", "error");
            }
        };

        const toggleKeyStatus = async (id, ativa) => {
            try {
                const res = await fetch(`${API_URL}/v1/api-keys/${id}`, {
                    method: 'PUT',
                    headers: { 'apikey': apiKey, 'Content-Type': 'application/json' },
                    body: JSON.stringify({ ativa: !ativa })
                });
                if (res.ok) {
                    loadKeys();
                    NotificationManager.show(ativa ? "API Key desativada" : "API Key ativada", "success");
                }
            } catch (e) {
                NotificationManager.show("Erro ao atualizar", "error");
            }
        };

        const deleteKey = async (id) => {
            if (!confirm("Tem certeza que deseja excluir esta API Key?")) return;
            try {
                const res = await fetch(`${API_URL}/v1/api-keys/${id}`, {
                    method: 'DELETE',
                    headers: { 'apikey': apiKey }
                });
                if (res.ok) {
                    loadKeys();
                    NotificationManager.show("API Key excluÃ­da", "success");
                } else {
                    const error = await res.json();
                    NotificationManager.show(error.error || "Erro ao excluir", "error");
                }
            } catch (e) {
                NotificationManager.show("Erro de conexÃ£o", "error");
            }
        };

        const renewKey = async (id, dias) => {
            try {
                const res = await fetch(`${API_URL}/v1/api-keys/${id}`, {
                    method: 'PUT',
                    headers: { 'apikey': apiKey, 'Content-Type': 'application/json' },
                    body: JSON.stringify({ renovarValidade: dias })
                });
                if (res.ok) {
                    loadKeys();
                    NotificationManager.show(`Validade renovada por ${dias} dias`, "success");
                }
            } catch (e) {
                NotificationManager.show("Erro ao renovar", "error");
            }
        };

        const copyToClipboard = (text) => {
            navigator.clipboard.writeText(text);
            NotificationManager.show("Copiado!", "success");
        };

        const formatDate = (date) => {
            if (!date) return 'Nunca';
            return new Date(date).toLocaleDateString('pt-BR');
        };

        const isExpired = (date) => {
            if (!date) return false;
            return new Date(date) < new Date();
        };

        const getValidadeLabel = (val) => {
            switch(val) {
                case '30': return '30 dias';
                case '90': return '90 dias';
                case '180': return '6 meses';
                case '365': return '1 ano';
                default: return 'Nunca expira';
            }
        };

        if (!isSuperAdmin) {
            return (
                <div className="bg-white dark:bg-dark-panel p-8 rounded-xl shadow text-center fade-in">
                    <i className="ph-bold ph-lock text-6xl text-gray-300 mb-4"></i>
                    <h3 className="text-xl font-bold dark:text-white mb-2">Acesso Restrito</h3>
                    <p className="text-gray-500">Apenas Super Admins podem gerenciar API Keys</p>
                </div>
            );
        }

        return (
            <div className="fade-in space-y-6">
                {/* Header */}
                <div className="flex justify-between items-center">
                    <div>
                        <h2 className="text-2xl font-bold dark:text-white">Gerenciamento de API Keys</h2>
                        <p className="text-sm text-gray-500 mt-1">Crie e gerencie chaves de acesso com validade e permissÃµes</p>
                    </div>
                    <button onClick={() => setShowCreateModal(true)} className="bg-green-600 text-white px-6 py-3 rounded-lg font-bold hover:bg-green-700 transition flex items-center gap-2">
                        <i className="ph-bold ph-plus text-xl"></i>Nova API Key
                    </button>
                </div>

                {/* Stats */}
                <div className="grid grid-cols-1 md:grid-cols-5 gap-4">
                    <div className="bg-white dark:bg-dark-panel p-4 rounded-xl shadow-sm border dark:border-gray-700">
                        <p className="text-sm text-gray-500 mb-1">Total</p>
                        <p className="text-3xl font-bold dark:text-white">{keys.length}</p>
                    </div>
                    <div className="bg-white dark:bg-dark-panel p-4 rounded-xl shadow-sm border dark:border-gray-700">
                        <p className="text-sm text-gray-500 mb-1">Super Admins</p>
                        <p className="text-3xl font-bold text-purple-600">{keys.filter(k => k.tipo === 'super_admin').length}</p>
                    </div>
                    <div className="bg-white dark:bg-dark-panel p-4 rounded-xl shadow-sm border dark:border-gray-700">
                        <p className="text-sm text-gray-500 mb-1">UsuÃ¡rios</p>
                        <p className="text-3xl font-bold text-blue-600">{keys.filter(k => k.tipo === 'user').length}</p>
                    </div>
                    <div className="bg-white dark:bg-dark-panel p-4 rounded-xl shadow-sm border dark:border-gray-700">
                        <p className="text-sm text-gray-500 mb-1">Ativas</p>
                        <p className="text-3xl font-bold text-green-600">{keys.filter(k => k.ativa && !k.expirada).length}</p>
                    </div>
                    <div className="bg-white dark:bg-dark-panel p-4 rounded-xl shadow-sm border dark:border-gray-700">
                        <p className="text-sm text-gray-500 mb-1">Expiradas</p>
                        <p className="text-3xl font-bold text-red-600">{keys.filter(k => k.expirada).length}</p>
                    </div>
                </div>

                {/* Table */}
                <div className="bg-white dark:bg-dark-panel rounded-xl shadow-sm border dark:border-gray-700 overflow-hidden">
                    {loading ? (
                        <div className="p-8 text-center">
                            <i className="ph-bold ph-circle-notch animate-spin text-4xl text-gray-400"></i>
                            <p className="mt-2 text-gray-500">Carregando...</p>
                        </div>
                    ) : (
                        <table className="w-full">
                            <thead className="bg-gray-50 dark:bg-gray-800 border-b dark:border-gray-700">
                                <tr>
                                    <th className="text-left p-4 text-sm font-bold text-gray-600 dark:text-gray-300">Nome</th>
                                    <th className="text-left p-4 text-sm font-bold text-gray-600 dark:text-gray-300">Tipo</th>
                                    <th className="text-left p-4 text-sm font-bold text-gray-600 dark:text-gray-300">Prefixo</th>
                                    <th className="text-left p-4 text-sm font-bold text-gray-600 dark:text-gray-300">InstÃ¢ncias</th>
                                    <th className="text-left p-4 text-sm font-bold text-gray-600 dark:text-gray-300">Expira</th>
                                    <th className="text-left p-4 text-sm font-bold text-gray-600 dark:text-gray-300">Ãšltimo Uso</th>
                                    <th className="text-left p-4 text-sm font-bold text-gray-600 dark:text-gray-300">Status</th>
                                    <th className="text-right p-4 text-sm font-bold text-gray-600 dark:text-gray-300">AÃ§Ãµes</th>
                                </tr>
                            </thead>
                            <tbody>
                                {keys.map(key => (
                                    <tr key={key.id} className="border-b dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-800">
                                        <td className="p-4">
                                            <span className="font-medium dark:text-white">{key.nome}</span>
                                        </td>
                                        <td className="p-4">
                                            <span className={`text-xs px-3 py-1 rounded-full text-white font-bold ${key.tipo === 'super_admin' ? 'badge-admin' : 'badge-user'}`}>
                                                {key.tipo === 'super_admin' ? 'ðŸ‘‘ Super Admin' : 'ðŸ‘¤ UsuÃ¡rio'}
                                            </span>
                                        </td>
                                        <td className="p-4">
                                            <code className="text-xs bg-gray-100 dark:bg-gray-700 px-2 py-1 rounded">{key.prefix}...</code>
                                        </td>
                                        <td className="p-4 text-sm text-gray-600 dark:text-gray-400">
                                            {key.tipo === 'super_admin' ? (
                                                <span className="text-purple-600 font-medium">Todas</span>
                                            ) : key.instanciasPermitidas?.length > 0 ? (
                                                <span>{key.instanciasPermitidas.length} instÃ¢ncia(s)</span>
                                            ) : (
                                                <span className="text-orange-600">Nenhuma</span>
                                            )}
                                        </td>
                                        <td className="p-4 text-sm">
                                            <span className={key.expirada ? 'text-red-600 font-bold' : 'text-gray-600 dark:text-gray-400'}>
                                                {formatDate(key.expiraEm)}
                                            </span>
                                        </td>
                                        <td className="p-4 text-sm text-gray-600 dark:text-gray-400">
                                            {key.ultimoUso ? formatDate(key.ultimoUso) : 'Nunca'}
                                        </td>
                                        <td className="p-4">
                                            {key.expirada ? (
                                                <span className="bg-red-100 text-red-800 text-xs px-3 py-1 rounded-full font-medium">Expirada</span>
                                            ) : key.ativa ? (
                                                <span className="bg-green-100 text-green-800 text-xs px-3 py-1 rounded-full font-medium">Ativa</span>
                                            ) : (
                                                <span className="bg-gray-100 text-gray-800 text-xs px-3 py-1 rounded-full font-medium">Inativa</span>
                                            )}
                                        </td>
                                        <td className="p-4">
                                            <div className="flex justify-end gap-1">
                                                <button onClick={() => toggleKeyStatus(key.id, key.ativa)} className={`p-2 rounded hover:bg-gray-100 dark:hover:bg-gray-700 ${key.ativa ? 'text-orange-600' : 'text-green-600'}`} title={key.ativa ? 'Desativar' : 'Ativar'}>
                                                    <i className={`ph-bold ${key.ativa ? 'ph-pause' : 'ph-play'}`}></i>
                                                </button>
                                                {key.expiraEm && (
                                                    <div className="relative group">
                                                        <button className="p-2 rounded hover:bg-gray-100 dark:hover:bg-gray-700 text-blue-600" title="Renovar">
                                                            <i className="ph-bold ph-clock-clockwise"></i>
                                                        </button>
                                                        <div className="absolute right-0 mt-2 w-40 bg-white dark:bg-gray-800 border dark:border-gray-700 rounded-lg shadow-lg hidden group-hover:block z-10">
                                                            <button onClick={() => renewKey(key.id, 30)} className="w-full text-left px-4 py-2 text-sm hover:bg-gray-100 dark:hover:bg-gray-700">+30 dias</button>
                                                            <button onClick={() => renewKey(key.id, 90)} className="w-full text-left px-4 py-2 text-sm hover:bg-gray-100 dark:hover:bg-gray-700">+90 dias</button>
                                                            <button onClick={() => renewKey(key.id, 180)} className="w-full text-left px-4 py-2 text-sm hover:bg-gray-100 dark:hover:bg-gray-700">+6 meses</button>
                                                            <button onClick={() => renewKey(key.id, 365)} className="w-full text-left px-4 py-2 text-sm hover:bg-gray-100 dark:hover:bg-gray-700">+1 ano</button>
                                                        </div>
                                                    </div>
                                                )}
                                                <button onClick={() => deleteKey(key.id)} className="p-2 rounded hover:bg-gray-100 dark:hover:bg-gray-700 text-red-600" title="Excluir">
                                                    <i className="ph-bold ph-trash"></i>
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    )}
                </div>

                {/* Modal Criar */}
                <Modal isOpen={showCreateModal} title="Criar Nova API Key" onClose={() => setShowCreateModal(false)} size="lg">
                    <div className="space-y-4">
                        <div>
                            <label className="text-sm font-bold text-gray-600 dark:text-gray-300 block mb-2">Nome *</label>
                            <input type="text" value={newKeyName} onChange={(e) => setNewKeyName(e.target.value)} placeholder="Ex: Cliente ABC, Bot Vendas" className="w-full p-3 border rounded-lg dark:bg-gray-700 dark:text-white" />
                        </div>

                        <div>
                            <label className="text-sm font-bold text-gray-600 dark:text-gray-300 block mb-2">Tipo de UsuÃ¡rio *</label>
                            <div className="grid grid-cols-2 gap-3">
                                <button onClick={() => setNewKeyTipo('user')} className={`p-4 rounded-lg border-2 transition ${newKeyTipo === 'user' ? 'border-green-500 bg-green-50 dark:bg-green-900/20' : 'border-gray-200 dark:border-gray-700'}`}>
                                    <div className="flex items-center gap-3">
                                        <div className="w-10 h-10 rounded-full badge-user flex items-center justify-center text-white text-xl">ðŸ‘¤</div>
                                        <div className="text-left">
                                            <p className="font-bold dark:text-white">UsuÃ¡rio Normal</p>
                                            <p className="text-xs text-gray-500">Acesso limitado Ã s instÃ¢ncias permitidas</p>
                                        </div>
                                    </div>
                                </button>
                                <button onClick={() => setNewKeyTipo('super_admin')} className={`p-4 rounded-lg border-2 transition ${newKeyTipo === 'super_admin' ? 'border-purple-500 bg-purple-50 dark:bg-purple-900/20' : 'border-gray-200 dark:border-gray-700'}`}>
                                    <div className="flex items-center gap-3">
                                        <div className="w-10 h-10 rounded-full badge-admin flex items-center justify-center text-white text-xl">ðŸ‘‘</div>
                                        <div className="text-left">
                                            <p className="font-bold dark:text-white">Super Admin</p>
                                            <p className="text-xs text-gray-500">Acesso total ao sistema</p>
                                        </div>
                                    </div>
                                </button>
                            </div>
                        </div>

                        <div>
                            <label className="text-sm font-bold text-gray-600 dark:text-gray-300 block mb-2">Validade</label>
                            <select value={newKeyValidade} onChange={(e) => setNewKeyValidade(e.target.value)} className="w-full p-3 border rounded-lg dark:bg-gray-700 dark:text-white">
                                <option value="never">ðŸ”“ Nunca expira</option>
                                <option value="30">ðŸ“… 30 dias</option>
                                <option value="90">ðŸ“… 90 dias</option>
                                <option value="180">ðŸ“… 6 meses</option>
                                <option value="365">ðŸ“… 1 ano</option>
                            </select>
                        </div>

                        {newKeyTipo === 'user' && (
                            <div>
                                <label className="text-sm font-bold text-gray-600 dark:text-gray-300 block mb-2">InstÃ¢ncias Permitidas</label>
                                {instances.length === 0 ? (
                                    <p className="text-sm text-orange-600 bg-orange-50 dark:bg-orange-900/20 p-3 rounded-lg">
                                        <i className="ph-bold ph-warning mr-2"></i>
                                        Nenhuma instÃ¢ncia disponÃ­vel. Crie instÃ¢ncias primeiro.
                                    </p>
                                ) : (
                                    <div className="grid grid-cols-2 gap-2 max-h-40 overflow-y-auto p-2 border rounded-lg dark:border-gray-700">
                                        {instances.map(inst => (
                                            <label key={inst.name} className="flex items-center gap-2 p-2 rounded hover:bg-gray-50 dark:hover:bg-gray-700 cursor-pointer">
                                                <input type="checkbox" checked={newKeyInstancias.includes(inst.name)} onChange={(e) => {
                                                    if (e.target.checked) {
                                                        setNewKeyInstancias([...newKeyInstancias, inst.name]);
                                                    } else {
                                                        setNewKeyInstancias(newKeyInstancias.filter(n => n !== inst.name));
                                                    }
                                                }} className="w-4 h-4 rounded border-gray-300" />
                                                <span className="text-sm dark:text-white">{inst.name}</span>
                                                <span className={`w-2 h-2 rounded-full ${inst.status === 'connected' ? 'bg-green-500' : 'bg-gray-400'}`}></span>
                                            </label>
                                        ))}
                                    </div>
                                )}
                            </div>
                        )}

                        <div className="bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-800 rounded-lg p-4">
                            <p className="text-sm text-blue-800 dark:text-blue-200">
                                <i className="ph-bold ph-info mr-2"></i>
                                <strong>Importante:</strong> A API Key completa serÃ¡ mostrada apenas uma vez apÃ³s a criaÃ§Ã£o. Guarde-a em local seguro!
                            </p>
                        </div>

                        <button onClick={createKey} className="w-full bg-green-600 text-white py-3 rounded-lg font-bold hover:bg-green-700 transition flex items-center justify-center gap-2">
                            <i className="ph-bold ph-key"></i>
                            Gerar API Key
                        </button>
                    </div>
                </Modal>

                {/* Modal Key Gerada */}
                <Modal isOpen={!!generatedKey} title="âœ… API Key Criada!" onClose={() => setGeneratedKey(null)} canClose={false}>
                    <div className="space-y-4">
                        <div className="bg-yellow-50 dark:bg-yellow-900/20 border border-yellow-200 dark:border-yellow-800 rounded-lg p-4">
                            <p className="text-sm text-yellow-800 dark:text-yellow-200 font-bold">
                                âš ï¸ ATENÃ‡ÃƒO: Esta Ã© a ÃšNICA vez que vocÃª verÃ¡ a API Key completa!
                            </p>
                        </div>

                        <div>
                            <label className="text-sm font-bold text-gray-600 dark:text-gray-300 block mb-2">Nome</label>
                            <p className="text-lg font-bold dark:text-white">{generatedKey?.nome}</p>
                        </div>

                        <div>
                            <label className="text-sm font-bold text-gray-600 dark:text-gray-300 block mb-2">Tipo</label>
                            <span className={`text-xs px-3 py-1 rounded-full text-white font-bold ${generatedKey?.tipo === 'super_admin' ? 'badge-admin' : 'badge-user'}`}>
                                {generatedKey?.tipo === 'super_admin' ? 'ðŸ‘‘ Super Admin' : 'ðŸ‘¤ UsuÃ¡rio'}
                            </span>
                        </div>

                        <div>
                            <label className="text-sm font-bold text-gray-600 dark:text-gray-300 block mb-2">API Key</label>
                            <div className="flex gap-2">
                                <code className="flex-1 bg-gray-100 dark:bg-gray-800 p-3 rounded-lg text-sm break-all font-mono border dark:border-gray-700">
                                    {generatedKey?.key}
                                </code>
                                <button onClick={() => copyToClipboard(generatedKey?.key)} className="bg-green-600 text-white px-4 rounded-lg hover:bg-green-700 flex items-center gap-2">
                                    <i className="ph-bold ph-copy"></i>
                                </button>
                            </div>
                        </div>

                        {generatedKey?.expiraEm && (
                            <div>
                                <label className="text-sm font-bold text-gray-600 dark:text-gray-300 block mb-2">Expira em</label>
                                <p className="dark:text-white">{formatDate(generatedKey.expiraEm)}</p>
                            </div>
                        )}

                        <button onClick={() => setGeneratedKey(null)} className="w-full bg-gray-600 text-white py-3 rounded-lg font-bold hover:bg-gray-700 transition">
                            Entendi, jÃ¡ copiei a key
                        </button>
                    </div>
                </Modal>
            </div>
        );
    };

    // ============================================
    // PÃGINA DE CHAT
    // ============================================

    const ChatPage = ({ apiKey, instances }) => {
        const [contacts, setContacts] = useState([]);
        const [activeChat, setActiveChat] = useState(null);
        const [filter, setFilter] = useState('all');
        const [selectedInstance, setSelectedInstance] = useState(null);
        const [searchQuery, setSearchQuery] = useState('');
        const [messageText, setMessageText] = useState('');
        const [sending, setSending] = useState(false);
        const [messages, setMessages] = useState([]);
        const messagesEndRef = useRef(null);

        const loadContacts = async (instName) => {
            if(!instName) return;
            setSelectedInstance(instName);
            setActiveChat(null);
            try {
                const res = await fetch(`${API_URL}/v1/contacts/${instName}`, { headers: { 'apikey': apiKey } });
                const data = await res.json();
                const sortedContacts = Array.isArray(data) ? data.sort((a,b)=>a.name.localeCompare(b.name)) : [];
                setContacts(sortedContacts);
                NotificationManager.show(`${sortedContacts.length} contatos carregados`, "success");
            } catch(e) { NotificationManager.show("Erro ao carregar contatos", "error"); setContacts([]); }
        };

        const loadMessages = async (jid) => {
            try {
                const res = await fetch(`${API_URL}/v1/messages/${selectedInstance}/${jid}`, { headers: { 'apikey': apiKey } });
                const data = await res.json();
                const msgs = data.map(m => ({ id: m.key?.id, fromMe: m.key?.fromMe, text: m.message?.conversation || m.message?.extendedTextMessage?.text || "(mensagem)", timestamp: (m.messageTimestamp || Date.now()) * 1000 }));
                setMessages(msgs);
                setTimeout(() => messagesEndRef.current?.scrollIntoView({ behavior: 'smooth' }), 200);
            } catch (e) { }
        };

        const selectChat = (contact) => { setActiveChat(contact); setMessages([]); const jid = contact.jid.includes("@") ? contact.jid : contact.jid + "@s.whatsapp.net"; loadMessages(jid); };

        const sendMessage = async () => {
            if(!activeChat || !messageText.trim() || !selectedInstance) { NotificationManager.show("Selecione um contato e digite uma mensagem", "error"); return; }
            setSending(true);
            try {
                const cleanNumber = activeChat.jid.split('@')[0];
                const res = await fetch(`${API_URL}/v1/message/text`, { method: 'POST', headers: { 'Content-Type': 'application/json', 'apikey': apiKey }, body: JSON.stringify({ instance: selectedInstance, number: cleanNumber, text: messageText }) });
                const data = await res.json();
                if(data.status === 'success') { const newMsg = { id: Date.now(), text: messageText, fromMe: true, timestamp: Date.now() }; setMessages([...messages, newMsg]); setMessageText(''); NotificationManager.show("Mensagem enviada!", "success"); } else { NotificationManager.show(data.error || "Erro ao enviar", "error"); }
            } catch(e) { NotificationManager.show("Falha no envio", "error"); } finally { setSending(false); }
        };

        const handleKeyPress = (e) => { if(e.key === 'Enter' && !e.shiftKey && !sending) { e.preventDefault(); sendMessage(); } };
        const filtered = contacts.filter(c => { if(filter === 'all') return true; if(filter === 'group') return c.is_group; return !c.is_group; });

        return (
            <div className="flex h-[calc(100vh-8rem)] bg-white dark:bg-dark-panel rounded-xl shadow border border-gray-200 dark:border-gray-700 overflow-hidden fade-in">
                <div className="w-1/3 border-r dark:border-gray-700 flex flex-col">
                    <div className="p-4 border-b dark:border-gray-700 bg-gray-50 dark:bg-gray-800">
                        <select onChange={(e) => loadContacts(e.target.value)} className="w-full p-2 mb-3 rounded border dark:bg-gray-700 dark:text-white" value={selectedInstance || ''}>
                            <option value="">Selecione InstÃ¢ncia...</option>
                            {instances.filter(i => i.status === 'connected').map(i => <option key={i.name} value={i.name}>{i.name} ({i.pushName || 'Sem nome'})</option>)}
                        </select>
                        <div className="flex gap-2">
                            {['all', 'user', 'group'].map(t => <button key={t} onClick={()=>setFilter(t)} className={`flex-1 text-xs py-1 rounded capitalize ${filter===t?'bg-green-100 text-green-800 font-bold dark:bg-green-900/30':'bg-gray-200 dark:bg-gray-700 dark:text-white'}`}>{t === 'all' ? 'Todos' : t === 'user' ? 'UsuÃ¡rios' : 'Grupos'}</button>)}
                        </div>
                    </div>
                    <div className="flex-1 overflow-y-auto">
                        {filtered.length === 0 ? <div className="flex flex-col items-center justify-center h-full text-gray-400"><i className="ph-bold ph-address-book text-6xl mb-4"></i><p className="text-sm">Nenhum contato</p></div> : filtered.map(c => (
                            <div key={c.jid} onClick={() => selectChat(c)} className={`p-3 flex items-center gap-3 cursor-pointer hover:bg-gray-100 dark:hover:bg-gray-700 border-b dark:border-gray-800 transition ${activeChat?.jid===c.jid?'bg-green-50 dark:bg-green-900/20 border-l-4 border-l-green-600':''}`}>
                                <div className="w-12 h-12 rounded-full bg-gradient-to-br from-green-400 to-green-600 flex items-center justify-center text-white text-xl font-bold">{c.is_group ? 'ðŸ‘¥' : c.name.charAt(0).toUpperCase()}</div>
                                <div className="flex-1 min-w-0"><h4 className="font-bold text-sm truncate dark:text-white">{c.name}</h4><p className="text-xs text-gray-500 truncate">{c.jid.split('@')[0]}</p></div>
                            </div>
                        ))}
                    </div>
                </div>
                <div className="flex-1 flex flex-col bg-[#efeae2] dark:bg-[#0b141a]">
                    {activeChat ? (
                        <>
                            <div className="p-4 bg-gray-100 dark:bg-gray-800 flex items-center gap-3 border-b dark:border-gray-700 shadow-sm">
                                <div className="w-12 h-12 rounded-full bg-gradient-to-br from-green-400 to-green-600 flex items-center justify-center text-white text-xl font-bold">{activeChat.is_group ? 'ðŸ‘¥' : activeChat.name.charAt(0).toUpperCase()}</div>
                                <div className="flex-1"><h3 className="font-bold dark:text-white">{activeChat.name}</h3><p className="text-xs text-gray-500">{activeChat.jid}</p></div>
                                <button onClick={() => setActiveChat(null)} className="text-gray-400 hover:text-red-500"><i className="ph-bold ph-x text-xl"></i></button>
                            </div>
                            <div className="flex-1 p-4 overflow-y-auto">
                                {messages.map((msg, idx) => (
                                    <div key={idx} className={`flex mb-3 ${msg.fromMe ? 'justify-end' : 'justify-start'}`}>
                                        <div className={`max-w-[70%] rounded-lg px-4 py-2 ${msg.fromMe ? 'bg-green-100 dark:bg-green-900/30' : 'bg-white dark:bg-gray-800'}`}>
                                            <p className="text-sm dark:text-white">{msg.text}</p>
                                            <span className="text-[10px] text-gray-500 mt-1 block">{new Date(msg.timestamp).toLocaleTimeString('pt-BR', {hour: '2-digit', minute:'2-digit'})}</span>
                                        </div>
                                    </div>
                                ))}
                                <div ref={messagesEndRef} />
                            </div>
                            <div className="p-3 bg-gray-100 dark:bg-gray-800 flex gap-2 border-t dark:border-gray-700">
                                <input value={messageText} onChange={(e) => setMessageText(e.target.value)} onKeyPress={handleKeyPress} className="flex-1 p-3 rounded-lg border dark:bg-gray-700 dark:text-white dark:border-gray-600" placeholder="Digite uma mensagem..." disabled={sending} />
                                <button onClick={sendMessage} disabled={sending || !messageText.trim()} className="bg-green-600 text-white px-4 rounded-lg hover:bg-green-700 disabled:opacity-50 transition"><i className="ph-fill ph-paper-plane-right text-xl"></i></button>
                            </div>
                        </>
                    ) : <div className="flex-1 flex items-center justify-center text-gray-400"><div className="text-center"><i className="ph-bold ph-chat-text text-8xl mb-4 text-gray-300"></i><p className="text-lg font-medium">Selecione um contato</p></div></div>}
                </div>
            </div>
        );
    };

    // ============================================
    // CARD DE INSTÃ‚NCIA
    // ============================================

    const InstanceCard = ({ inst, onConnect, onAction, onUpdateInfo }) => {
        const [loading, setLoading] = useState(false);
        const handle = async (act) => { setLoading(true); await onAction(act, inst.name); setLoading(false); };
        useEffect(() => { if(inst.status === 'connected' && !inst.jid) { onUpdateInfo(inst.name); } }, [inst.status]);
        return (
            <div className="bg-white dark:bg-dark-panel rounded-xl shadow-sm border border-gray-200 dark:border-gray-700 p-5 fade-in">
                <div className="flex items-center gap-4 mb-4">
                    <div className="relative">
                        {inst.avatar ? <img src={inst.avatar} className="w-16 h-16 rounded-full border-2 border-gray-100 object-cover" onError={(e)=>{e.target.src='https://via.placeholder.com/150?text=WA'}} /> : <div className="w-16 h-16 rounded-full bg-gray-100 dark:bg-gray-800 flex items-center justify-center text-3xl">{inst.status==='connected'?'ðŸ¤–':'ðŸ”Œ'}</div>}
                        <div className={`absolute bottom-0 right-0 w-4 h-4 rounded-full border-2 border-white ${inst.status==='connected'?'bg-green-500':'bg-red-500'}`}></div>
                    </div>
                    <div className="flex-1 min-w-0">
                        <h3 className="font-bold text-lg dark:text-white truncate">{inst.pushName || inst.name}</h3>
                        <p className="text-xs text-gray-500 bg-gray-100 dark:bg-gray-800 px-2 py-0.5 rounded mt-1 inline-block truncate max-w-full">{inst.jid ? inst.jid.split('@')[0] : "Desconectado"}</p>
                    </div>
                </div>
                {inst.status === 'connected' && (
                    <div className="grid grid-cols-3 gap-2 mb-4">
                        <div className="bg-blue-50 dark:bg-blue-900/20 p-2 rounded text-center border border-blue-100 dark:border-blue-800"><p className="text-[10px] font-bold text-blue-600">CONTATOS</p><p className="text-lg font-bold text-blue-800 dark:text-blue-300">{inst.stats?.contacts || 0}</p></div>
                        <div className="bg-purple-50 dark:bg-purple-900/20 p-2 rounded text-center border border-purple-100 dark:border-purple-800"><p className="text-[10px] font-bold text-purple-600">GRUPOS</p><p className="text-lg font-bold text-purple-800 dark:text-purple-300">{inst.stats?.groups || 0}</p></div>
                        <div className="bg-green-50 dark:bg-green-900/20 p-2 rounded text-center border border-green-100 dark:border-green-800"><p className="text-[10px] font-bold text-green-600">MENSAGENS</p><p className="text-lg font-bold text-green-800 dark:text-green-300">{inst.stats?.messagesSent || 0}</p></div>
                    </div>
                )}
                <div className="grid grid-cols-4 gap-2">
                    {inst.status !== 'connected' ? (
                        <button onClick={() => onConnect(inst.name)} disabled={loading} className="col-span-3 bg-green-600 hover:bg-green-700 text-white py-2 rounded-lg text-sm font-bold flex items-center justify-center gap-2 transition shadow-sm disabled:opacity-50">{loading ? <i className="ph ph-spinner animate-spin"></i> : <i className="ph-bold ph-qr-code"></i>}Conectar</button>
                    ) : (
                        <>
                            <button onClick={() => handle('refresh')} title="Sincronizar" className="bg-blue-50 hover:bg-blue-100 text-blue-600 py-2 rounded-lg flex justify-center"><i className={`ph-bold ph-arrows-clockwise ${loading?'animate-spin':''}`}></i></button>
                            <button onClick={() => handle('restart')} title="Reiniciar" className="bg-orange-50 hover:bg-orange-100 text-orange-600 py-2 rounded-lg flex justify-center"><i className="ph-bold ph-lightning"></i></button>
                            <button onClick={() => handle('logout')} title="Desconectar" className="bg-red-50 hover:bg-red-100 text-red-600 py-2 rounded-lg flex justify-center"><i className="ph-bold ph-plug"></i></button>
                        </>
                    )}
                    <button onClick={() => handle('delete')} title="Excluir" className="bg-gray-100 hover:bg-red-500 hover:text-white text-gray-500 py-2 rounded-lg flex justify-center transition"><i className="ph-bold ph-trash"></i></button>
                </div>
            </div>
        );
    };

    // ============================================
    // DASHBOARD PRINCIPAL
    // ============================================

    const Dashboard = ({ apiKey, userInfo, onLogout }) => {
        const [activeTab, setActiveTab] = useState('instances');
        const [instances, setInstances] = useState([]);
        const [modals, setModals] = useState({});
        const [qrData, setQrData] = useState(null);
        const [pairCode, setPairCode] = useState(null);
        const [phoneInput, setPhoneInput] = useState("");
        const [selectedInst, setSelectedInst] = useState(null);
        const [darkMode, setDarkMode] = useState(false);
        const [showSyncModal, setShowSyncModal] = useState(false);
        const [syncStatus, setSyncStatus] = useState({});
        const [syncInstanceName, setSyncInstanceName] = useState('');
        const [confirmModal, setConfirmModal] = useState({ isOpen: false, title: '', message: '', type: 'warning', onConfirm: null });

        const isSuperAdmin = userInfo?.isSuperAdmin || false;

        useEffect(() => {
            loadInstances();
            if(darkMode) document.documentElement.classList.add('dark'); else document.documentElement.classList.remove('dark');
        }, [darkMode]);

        const loadInstances = async () => {
            try {
                const res = await fetch(`${API_URL}/v1/instances`, { headers: { 'apikey': apiKey } });
                if (res.ok) {
                    const data = await res.json();
                    setInstances(data);
                }
            } catch (e) {
                console.error("Erro ao carregar instÃ¢ncias:", e);
            }
        };

        const openModal = (t, i) => { setSelectedInst(i); setModals({...modals, [t]: true}); };
        const closeModal = (t) => setModals({...modals, [t]: false});

        const addInstance = async () => {
            const name = document.getElementById('newInstName').value.replace(/\s+/g, '');
            if(!name) { NotificationManager.show("Digite um nome", "error"); return; }

            try {
                const res = await fetch(`${API_URL}/v1/instances`, {
                    method: 'POST',
                    headers: { 'apikey': apiKey, 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name })
                });
                if (res.ok) {
                    closeModal('add');
                    loadInstances();
                    NotificationManager.show(`InstÃ¢ncia "${name}" criada!`, "success");
                } else {
                    const error = await res.json();
                    NotificationManager.show(error.error || "Erro ao criar", "error");
                }
            } catch (e) {
                NotificationManager.show("Erro de conexÃ£o", "error");
            }
        };

        const pollSyncStatus = async (instanceName) => {
            try {
                const res = await fetch(`${API_URL}/v1/instance/${instanceName}/sync-status`, { headers: { 'apikey': apiKey } });
                const data = await res.json();
                setSyncStatus(data);
                if(data.syncing) { setTimeout(() => pollSyncStatus(instanceName), 2000); }
            } catch(e) { }
        };

        const connectInstance = async (name) => {
            setInstances(instances.map(i => i.name === name ? {...i, status: 'connecting'} : i));
            NotificationManager.show(`Conectando ${name}...`, "info");
            try {
                const res = await fetch(`${API_URL}/session/start`, { method: 'POST', headers: { 'apikey': apiKey, 'Content-Type': 'application/json' }, body: JSON.stringify({ instance: name }) });
                const data = await res.json();
                if (data.qrcode) {
                    setQrData(data.qrcode);
                    openModal('qr', { name });
                    const poll = setInterval(async () => {
                        const iRes = await fetch(`${API_URL}/v1/instance/${name}/info`, { headers: { 'apikey': apiKey } });
                        const info = await iRes.json();
                        if(info.status === 'connected') { 
                            clearInterval(poll); 
                            closeModal('qr'); 
                            loadInstances();
                            setSyncInstanceName(name);
                            setShowSyncModal(true);
                            pollSyncStatus(name);
                            NotificationManager.show(`${name} conectado!`, "success");
                        }
                    }, 2000);
                } else if (data.status === 'CONNECTED') {
                    loadInstances();
                    NotificationManager.show(`${name} jÃ¡ estÃ¡ conectado!`, "success");
                } else {
                    NotificationManager.show(data.error || "Erro ao conectar", "error");
                    loadInstances();
                }
            } catch(e) { NotificationManager.show("Erro de conexÃ£o", "error"); loadInstances(); }
        };

        const handleAction = async (action, name) => {
            if(action === 'delete') {
                setConfirmModal({ isOpen: true, title: 'Excluir InstÃ¢ncia', message: `Tem certeza que deseja EXCLUIR a instÃ¢ncia "${name}"?\n\nTodos os dados serÃ£o perdidos!`, type: 'danger', onConfirm: async () => { 
                    setConfirmModal({ ...confirmModal, isOpen: false }); 
                    await fetch(`${API_URL}/v1/instances/${name}`, { method: 'DELETE', headers: { 'apikey': apiKey } }); 
                    loadInstances(); 
                    NotificationManager.show("InstÃ¢ncia excluÃ­da!", "success"); 
                } });
            } else if(action === 'logout') {
                setConfirmModal({ isOpen: true, title: 'Desconectar', message: `Deseja desconectar "${name}"?`, type: 'warning', onConfirm: async () => { 
                    setConfirmModal({ ...confirmModal, isOpen: false }); 
                    await fetch(`${API_URL}/session/logout`, { method: 'POST', headers: { 'apikey': apiKey, 'Content-Type': 'application/json' }, body: JSON.stringify({ instance: name }) }); 
                    loadInstances(); 
                    NotificationManager.show("Desconectado!", "success"); 
                } });
            } else if(action === 'refresh') { 
                loadInstances(); 
                NotificationManager.show("Atualizado!", "success"); 
            } else if(action === 'restart') {
                setConfirmModal({ isOpen: true, title: 'Reiniciar', message: `Deseja reiniciar "${name}"?`, type: 'info', onConfirm: async () => { 
                    setConfirmModal({ ...confirmModal, isOpen: false }); 
                    await fetch(`${API_URL}/session/logout`, { method: 'POST', headers: { 'apikey': apiKey, 'Content-Type': 'application/json' }, body: JSON.stringify({ instance: name }) }); 
                    setTimeout(() => connectInstance(name), 1500); 
                } });
            }
        };

        const handlePairing = async () => {
            const res = await fetch(`${API_URL}/session/pair-code`, { method: 'POST', headers: { 'apikey': apiKey, 'Content-Type': 'application/json' }, body: JSON.stringify({ instance: selectedInst.name, phoneNumber: phoneInput }) });
            const data = await res.json();
            if(data.code) { setPairCode(data.code); NotificationManager.show("CÃ³digo gerado!", "success"); } else { NotificationManager.show(data.error, "error"); }
        };

        const totalContacts = instances.reduce((acc, curr) => acc + (curr.stats?.contacts || 0), 0);
        const totalGroups = instances.reduce((acc, curr) => acc + (curr.stats?.groups || 0), 0);
        const totalMessages = instances.reduce((acc, curr) => acc + (curr.stats?.messagesSent || 0), 0);
        const onlineCount = instances.filter(i => i.status === 'connected').length;

        // Tabs disponÃ­veis baseado no tipo de usuÃ¡rio
        const tabs = isSuperAdmin 
            ? ['instances', 'chat', 'apikeys', 'settings', 'events', 'integrations']
            : ['instances', 'chat', 'settings'];

        return (
            <div className="flex h-screen overflow-hidden font-sans bg-gray-50 dark:bg-[#0c1317]">
                <ConfirmModal isOpen={confirmModal.isOpen} title={confirmModal.title} message={confirmModal.message} type={confirmModal.type} onConfirm={confirmModal.onConfirm} onCancel={() => setConfirmModal({ ...confirmModal, isOpen: false })} />
                <SyncModal isOpen={showSyncModal} onClose={() => setShowSyncModal(false)} instanceName={syncInstanceName} syncStatus={syncStatus} onMinimize={() => setShowSyncModal(false)} />

                <Modal isOpen={modals.add} title="Nova InstÃ¢ncia" onClose={() => closeModal('add')}>
                    <input id="newInstName" type="text" className="w-full p-3 border rounded mb-4 dark:bg-gray-700 dark:text-white" placeholder="Nome da instÃ¢ncia" />
                    <button onClick={addInstance} className="w-full bg-green-600 text-white py-2 rounded font-bold hover:bg-green-700">Criar InstÃ¢ncia</button>
                </Modal>

                <Modal isOpen={modals.qr} title="Escanear QR Code" onClose={() => closeModal('qr')}>
                    <div className="flex justify-center mb-4"><img src={qrData} className="w-64 border-4 border-white shadow-lg rounded" alt="QR Code" /></div>
                    <p className="text-center text-sm text-gray-500 mb-4">Abra o WhatsApp e escaneie o cÃ³digo</p>
                    <div className="text-center"><button onClick={() => { closeModal('qr'); openModal('pair', selectedInst); }} className="text-blue-500 font-bold hover:underline">Usar CÃ³digo de Pareamento</button></div>
                </Modal>

                <Modal isOpen={modals.pair} title="Pareamento" onClose={() => closeModal('pair')}>
                    {!pairCode ? (
                        <><input value={phoneInput} onChange={e=>setPhoneInput(e.target.value)} className="w-full p-3 border rounded mb-4 dark:bg-gray-700 dark:text-white" placeholder="5511999999999" /><button onClick={handlePairing} className="w-full bg-green-600 text-white py-2 rounded font-bold hover:bg-green-700">Gerar CÃ³digo</button></>
                    ) : (
                        <div className="text-center"><p className="text-sm text-gray-500 mb-4">Digite este cÃ³digo no WhatsApp:</p><div className="text-3xl font-mono font-bold p-4 bg-gray-100 dark:bg-gray-800 rounded">{pairCode}</div></div>
                    )}
                </Modal>

                {/* Sidebar */}
                <div className="w-72 bg-white dark:bg-dark-panel border-r border-gray-200 dark:border-gray-800 flex flex-col z-10">
                    <div className="p-6 flex items-center gap-3">
                        <div className="w-10 h-10 bg-green-600 rounded flex items-center justify-center text-white"><i className="ph-bold ph-whatsapp-logo text-2xl"></i></div>
                        <span className="font-bold text-xl dark:text-white">NexusWA</span>
                    </div>
                    
                    {/* User Info */}
                    <div className="px-4 pb-4">
                        <div className="bg-gray-50 dark:bg-gray-800 rounded-lg p-3">
                            <div className="flex items-center gap-2">
                                <div className={`w-8 h-8 rounded-full flex items-center justify-center text-white text-sm ${isSuperAdmin ? 'badge-admin' : 'badge-user'}`}>
                                    {isSuperAdmin ? 'ðŸ‘‘' : 'ðŸ‘¤'}
                                </div>
                                <div className="flex-1 min-w-0">
                                    <p className="text-sm font-bold dark:text-white truncate">{userInfo?.nome || 'UsuÃ¡rio'}</p>
                                    <p className="text-xs text-gray-500">{isSuperAdmin ? 'Super Admin' : 'UsuÃ¡rio'}</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <nav className="p-4 space-y-2 flex-1">
                        {tabs.map(tab => (
                            <button key={tab} onClick={() => setActiveTab(tab)} className={`w-full flex items-center gap-3 px-4 py-3 rounded-lg capitalize transition ${activeTab===tab?'bg-green-50 text-green-700 font-bold dark:bg-green-900/20':'text-gray-500 hover:bg-gray-100 dark:hover:bg-gray-800'}`}>
                                <i className={`ph-bold ${tab==='instances'?'ph-squares-four':tab==='chat'?'ph-chat-circle-text':tab==='apikeys'?'ph-key':tab==='settings'?'ph-gear':tab==='events'?'ph-broadcast':'ph-plugs'} text-lg`}></i>
                                {tab === 'apikeys' ? 'API Keys' : tab}
                            </button>
                        ))}
                    </nav>
                    <div className="p-4 border-t dark:border-gray-800">
                        <div className="flex justify-between mb-4"><span className="dark:text-gray-300 text-sm">Modo Escuro</span><button onClick={() => setDarkMode(!darkMode)} className={`w-10 h-5 rounded-full relative transition ${darkMode ? 'bg-green-600' : 'bg-gray-300'}`}><div className={`w-3 h-3 bg-white rounded absolute top-1 transition-all ${darkMode?'left-6':'left-1'}`}></div></button></div>
                        <button onClick={onLogout} className="w-full text-red-500 font-bold text-sm hover:bg-red-50 dark:hover:bg-red-900/20 py-2 rounded transition">Sair</button>
                    </div>
                </div>

                {/* Main Content */}
                <div className="flex-1 overflow-y-auto p-8">
                    <div className="max-w-7xl mx-auto pb-10">
                        {activeTab === 'instances' && (
                            <div className="fade-in space-y-8">
                                <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
                                    <div className="bg-white dark:bg-dark-panel p-4 rounded-xl shadow-sm border dark:border-gray-700 flex items-center gap-4"><div className="w-12 h-12 rounded-full bg-green-100 text-green-600 flex items-center justify-center text-2xl"><i className="ph-fill ph-whatsapp-logo"></i></div><div><p className="text-gray-500 text-xs font-bold uppercase">InstÃ¢ncias</p><h3 className="text-2xl font-bold dark:text-white">{instances.length} ({onlineCount} on)</h3></div></div>
                                    <div className="bg-white dark:bg-dark-panel p-4 rounded-xl shadow-sm border dark:border-gray-700 flex items-center gap-4"><div className="w-12 h-12 rounded-full bg-blue-100 text-blue-600 flex items-center justify-center text-2xl"><i className="ph-fill ph-users"></i></div><div><p className="text-gray-500 text-xs font-bold uppercase">Contatos</p><h3 className="text-2xl font-bold dark:text-white">{totalContacts}</h3></div></div>
                                    <div className="bg-white dark:bg-dark-panel p-4 rounded-xl shadow-sm border dark:border-gray-700 flex items-center gap-4"><div className="w-12 h-12 rounded-full bg-purple-100 text-purple-600 flex items-center justify-center text-2xl"><i className="ph-fill ph-chats-circle"></i></div><div><p className="text-gray-500 text-xs font-bold uppercase">Grupos</p><h3 className="text-2xl font-bold dark:text-white">{totalGroups}</h3></div></div>
                                    <div className="bg-white dark:bg-dark-panel p-4 rounded-xl shadow-sm border dark:border-gray-700 flex items-center gap-4"><div className="w-12 h-12 rounded-full bg-orange-100 text-orange-600 flex items-center justify-centertext-2xl"><i className="ph-fill ph-envelope-open"></i></div><div><p className="text-gray-500 text-xs font-bold uppercase">Mensagens</p><h3 className="text-2xl font-bold dark:text-white">{totalMessages}</h3></div></div>
</div>
<div className="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6">
{isSuperAdmin && (
<div onClick={() => openModal('add')} className="bg-white dark:bg-dark-panel border-2 border-dashed border-gray-300 dark:border-gray-600 rounded-xl p-6 flex flex-col items-center justify-center text-gray-400 hover:border-green-500 hover:text-green-500 cursor-pointer transition h-full min-h-[16rem]"><i className="ph-bold ph-plus text-3xl"></i><span className="mt-2 font-bold">Nova InstÃ¢ncia</span></div>
)}
{instances.map(inst => <InstanceCard key={inst.name} inst={inst} onConnect={connectInstance} onAction={handleAction} onUpdateInfo={loadInstances} />)}
</div>
</div>
)}
{activeTab === 'chat' && <ChatPage apiKey={apiKey} instances={instances} />}
{activeTab === 'settings' && <SettingsPage apiKey={apiKey} />}
{activeTab === 'events' && <EventsPage apiKey={apiKey} />}
{activeTab === 'integrations' && <IntegrationsPage />}
{activeTab === 'apikeys' && <ApiKeysPage apiKey={apiKey} isSuperAdmin={isSuperAdmin} instances={instances} />}
</div>
</div>
</div>
);
}

// ============================================
// TELA DE LOGIN
// ============================================

const LoginScreen = ({ onLogin, error }) => {
    const [key, setKey] = useState('');
    const [loading, setLoading] = useState(false);

    const handleLogin = async () => {
        if (!key.trim()) {
            NotificationManager.show("Digite sua API Key", "error");
            return;
        }
        setLoading(true);
        await onLogin(key);
        setLoading(false);
    };

    const handleKeyPress = (e) => {
        if (e.key === 'Enter') handleLogin();
    };

    return (
        <div className="min-h-screen flex items-center justify-center bg-gradient-to-br from-green-600 to-green-800">
            <div className="bg-white dark:bg-dark-panel p-8 rounded-2xl shadow-2xl w-full max-w-md text-center">
                <div className="w-20 h-20 bg-green-600 rounded-full mx-auto mb-6 flex items-center justify-center shadow-lg">
                    <i className="ph-bold ph-whatsapp-logo text-4xl text-white"></i>
                </div>
                <h2 className="text-3xl font-bold mb-2 dark:text-white">NexusWA</h2>
                <p className="text-gray-500 mb-8">Enterprise WhatsApp Platform</p>
                
                {error && (
                    <div className="bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800 rounded-lg p-3 mb-4">
                        <p className="text-red-600 dark:text-red-400 text-sm">{error}</p>
                    </div>
                )}
                
                <input 
                    type="password" 
                    value={key}
                    onChange={e=>setKey(e.target.value)} 
                    onKeyPress={handleKeyPress}
                    className="w-full p-4 border rounded-lg mb-4 dark:bg-gray-700 dark:text-white text-center font-mono" 
                    placeholder="Cole sua API Key aqui"
                    disabled={loading}
                />
                <button 
                    onClick={handleLogin} 
                    disabled={loading}
                    className="w-full bg-green-600 text-white py-4 rounded-lg font-bold hover:bg-green-700 transition disabled:opacity-50 flex items-center justify-center gap-2"
                >
                    {loading ? (
                        <><i className="ph-bold ph-circle-notch animate-spin"></i>Verificando...</>
                    ) : (
                        <><i className="ph-bold ph-sign-in"></i>Entrar</>
                    )}
                </button>

                <p className="text-xs text-gray-400 mt-6">
                    Sua API Key foi fornecida pelo administrador do sistema
                </p>
            </div>
        </div>
    );
};

// ============================================
// APP PRINCIPAL
// ============================================

const App = () => {
    const [auth, setAuth] = useState(false);
    const [apiKey, setApiKey] = useState('');
    const [userInfo, setUserInfo] = useState(null);
    const [loginError, setLoginError] = useState('');
    const [loading, setLoading] = useState(true);

    useEffect(() => {
        const savedKey = localStorage.getItem('nexus_apikey');
        if (savedKey) {
            validateAndLogin(savedKey);
        } else {
            setLoading(false);
        }
    }, []);

    const validateAndLogin = async (key) => {
        try {
            const res = await fetch(`${API_URL}/v1/me`, { headers: { 'apikey': key } });
            if (res.ok) {
                const data = await res.json();
                setApiKey(key);
                setUserInfo(data);
                setAuth(true);
                setLoginError('');
                localStorage.setItem('nexus_apikey', key);
                NotificationManager.show(`Bem-vindo, ${data.nome}!`, "success");
            } else {
                const error = await res.json();
                setLoginError(error.error || 'API Key invÃ¡lida');
                localStorage.removeItem('nexus_apikey');
            }
        } catch (e) {
            setLoginError('Erro de conexÃ£o com o servidor');
        } finally {
            setLoading(false);
        }
    };

    const handleLogin = async (key) => {
        setLoading(true);
        await validateAndLogin(key);
    };

    const handleLogout = () => {
        localStorage.removeItem('nexus_apikey');
        setAuth(false);
        setApiKey('');
        setUserInfo(null);
        NotificationManager.show("AtÃ© logo!", "info");
    };

    if (loading) {
        return (
            <div className="min-h-screen flex items-center justify-center bg-gradient-to-br from-green-600 to-green-800">
                <div className="text-center text-white">
                    <i className="ph-bold ph-circle-notch animate-spin text-6xl mb-4"></i>
                    <p className="text-xl">Carregando...</p>
                </div>
            </div>
        );
    }

    return auth ? (
        <Dashboard apiKey={apiKey} userInfo={userInfo} onLogout={handleLogout} />
    ) : (
        <LoginScreen onLogin={handleLogin} error={loginError} />
    );
};

ReactDOM.createRoot(document.getElementById('root')).render(<App />);

</script>
</body>
</html>