<!DOCTYPE html>
<html lang="pt-br" class="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NexusWA | Enterprise Dashboard</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: { extend: { colors: { wa: { light: '#00a884', dark: '#005c4b' }, dark: { bg: '#111b21', panel: '#202c33', text: '#e9edef' } } } }
        }
    </script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: rgba(0,0,0,0.2); border-radius: 3px; }
        .dark ::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.2); }
        .fade-in { animation: fadeIn 0.2s ease-out; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        
        /* Notifica√ß√£o estilo WhatsApp */
        .wa-notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 8px 24px rgba(0,0,0,0.15);
            padding: 16px;
            min-width: 300px;
            z-index: 9999;
            animation: slideIn 0.3s ease-out;
        }
        .dark .wa-notification {
            background: #2a3942;
            box-shadow: 0 8px 24px rgba(0,0,0,0.5);
        }
        @keyframes slideIn {
            from { transform: translateX(400px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        .wa-notification.success { border-left: 4px solid #25d366; }
        .wa-notification.error { border-left: 4px solid #f44336; }
        .wa-notification.info { border-left: 4px solid #2196F3; }
    </style>
</head>
<body class="bg-gray-100 text-gray-900 dark:bg-dark-bg dark:text-dark-text transition-colors duration-300">
<div id="root"></div>
<div id="notifications"></div>
<script type="text/babel">
    const { useState, useEffect, useRef } = React;
    const API_URL = "http://localhost:8082/v1";
    const generateUUID = () => 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, c => (c == 'x' ? Math.random() * 16 | 0 : (Math.random() * 16 | 0) & 0x3 | 0x8).toString(16));

    // === SISTEMA DE NOTIFICA√á√ïES ESTILO WHATSAPP ===
    const NotificationManager = {
        show: (message, type = 'info', duration = 4000) => {
            const container = document.getElementById('notifications');
            const notif = document.createElement('div');
            notif.className = `wa-notification ${type}`;
            
            const icon = type === 'success' ? '‚úì' : type === 'error' ? '‚úï' : '‚Ñπ';
            const color = type === 'success' ? '#25d366' : type === 'error' ? '#f44336' : '#2196F3';
            
            notif.innerHTML = `
                <div class="flex items-start gap-3">
                    <div style="background: ${color}; color: white; width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold;">
                        ${icon}
                    </div>
                    <div class="flex-1">
                        <p class="font-medium text-gray-900 dark:text-white">${message}</p>
                        <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">${new Date().toLocaleTimeString('pt-BR')}</p>
                    </div>
                </div>
            `;
            
            container.appendChild(notif);
            
            setTimeout(() => {
                notif.style.animation = 'slideIn 0.3s ease-out reverse';
                setTimeout(() => notif.remove(), 300);
            }, duration);
        }
    };

    // --- COMPONENTES UI ---
    
    // CORRE√á√ÉO APLICADA AQUI: Adicionado onClick no container pai e stopPropagation no filho
    const Modal = ({ isOpen, title, onClose, children }) => {
        if (!isOpen) return null;
        return (
            <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/60 backdrop-blur-sm fade-in" onClick={onClose}>
                <div 
                    className="bg-white dark:bg-dark-panel rounded-xl shadow-2xl max-w-md w-full border border-gray-200 dark:border-gray-700 relative overflow-hidden" 
                    onClick={(e) => e.stopPropagation()}
                >
                    <div className="flex justify-between items-center p-4 border-b border-gray-100 dark:border-gray-700 bg-gray-50 dark:bg-gray-800/50">
                        <h3 className="font-bold text-lg dark:text-white">{title}</h3>
                        <button onClick={onClose} className="text-gray-400 hover:text-red-500"><i className="ph-bold ph-x text-lg"></i></button>
                    </div>
                    <div className="p-6">{children}</div>
                </div>
            </div>
        );
    };

    const Toggle = ({ label, checked, onChange }) => (
        <div className="flex items-center justify-between py-3 border-b border-gray-200 dark:border-gray-700 last:border-0">
            <span className="text-sm font-medium dark:text-gray-200">{label}</span>
            <label className="relative inline-flex items-center cursor-pointer">
                <input type="checkbox" className="sr-only peer" checked={checked} onChange={(e) => onChange(e.target.checked)} />
                <div className="w-11 h-6 bg-gray-300 peer-focus:outline-none rounded-full peer dark:bg-gray-700 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-green-600"></div>
            </label>
        </div>
    );

    // === MODAL DE CONFIRMA√á√ÉO CUSTOMIZADO ===
    const ConfirmModal = ({ isOpen, title, message, onConfirm, onCancel, confirmText = "Confirmar", cancelText = "Cancelar", type = "warning" }) => {
        if (!isOpen) return null;
        
        const colors = {
            warning: { bg: 'bg-orange-50 dark:bg-orange-900/20', icon: 'text-orange-600', button: 'bg-orange-600 hover:bg-orange-700' },
            danger: { bg: 'bg-red-50 dark:bg-red-900/20', icon: 'text-red-600', button: 'bg-red-600 hover:bg-red-700' },
            success: { bg: 'bg-green-50 dark:bg-green-900/20', icon: 'text-green-600', button: 'bg-green-600 hover:bg-green-700' },
            info: { bg: 'bg-blue-50 dark:bg-blue-900/20', icon: 'text-blue-600', button: 'bg-blue-600 hover:bg-blue-700' }
        };
        
        const color = colors[type];
        
        return (
            <div className="fixed inset-0 z-[100] flex items-center justify-center p-4 bg-black/60 backdrop-blur-sm fade-in" onClick={onCancel}>
                <div className="bg-white dark:bg-dark-panel rounded-xl shadow-2xl max-w-md w-full border border-gray-200 dark:border-gray-700 relative overflow-hidden" onClick={(e) => e.stopPropagation()}>
                    <div className={`p-6 ${color.bg}`}>
                        <div className="flex items-start gap-4">
                            <div className={`w-12 h-12 rounded-full flex items-center justify-center ${color.bg} ${color.icon}`}>
                                {type === 'warning' && <i className="ph-bold ph-warning text-2xl"></i>}
                                {type === 'danger' && <i className="ph-bold ph-trash text-2xl"></i>}
                                {type === 'success' && <i className="ph-bold ph-check text-2xl"></i>}
                                {type === 'info' && <i className="ph-bold ph-info text-2xl"></i>}
                            </div>
                            <div className="flex-1">
                                <h3 className="font-bold text-lg mb-2 dark:text-white">{title}</h3>
                                <p className="text-sm text-gray-600 dark:text-gray-300 whitespace-pre-line">{message}</p>
                            </div>
                        </div>
                    </div>
                    
                    <div className="p-6 flex gap-3">
                        <button 
                            onClick={onCancel}
                            className="flex-1 bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-white px-4 py-3 rounded-lg font-bold hover:bg-gray-300 dark:hover:bg-gray-600 transition"
                        >
                            {cancelText}
                        </button>
                        <button 
                            onClick={onConfirm}
                            className={`flex-1 text-white px-4 py-3 rounded-lg font-bold transition ${color.button}`}
                        >
                            {confirmText}
                        </button>
                    </div>
                </div>
            </div>
        );
    };

    // --- P√ÅGINAS ---

    const SettingsPage = ({ apiKey }) => {
        const [config, setConfig] = useState({ 
            rejectCalls: false, 
            ignoreGroups: true,  // ‚úÖ MARCADO POR PADR√ÉO
            alwaysOnline: false, 
            syncHistory: false 
        });
        
        const save = async () => {
            try {
                await fetch(`${API_URL}/settings/global/save`, { 
                    method: 'POST', 
                    headers: { 
                        'apikey': apiKey,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(config)
                });
                NotificationManager.show("Configura√ß√µes salvas com sucesso!", "success");
            } catch(e) {
                NotificationManager.show("Erro ao salvar configura√ß√µes", "error");
            }
        };
        
        return (
            <div className="bg-white dark:bg-dark-panel p-6 rounded-xl shadow fade-in">
                <h3 className="text-lg font-bold mb-4 dark:text-white flex items-center gap-2">
                    <i className="ph-bold ph-gear text-2xl"></i>
                    Configura√ß√µes Gerais
                </h3>
                <div className="space-y-1">
                    <Toggle 
                        label="Rejeitar Chamadas" 
                        checked={config.rejectCalls} 
                        onChange={v=>setConfig({...config, rejectCalls:v})} 
                    />
                    <Toggle 
                        label="Ignorar Grupos (Recomendado)" 
                        checked={config.ignoreGroups} 
                        onChange={v=>setConfig({...config, ignoreGroups:v})} 
                    />
                    <Toggle 
                        label="Sempre Online" 
                        checked={config.alwaysOnline} 
                        onChange={v=>setConfig({...config, alwaysOnline:v})} 
                    />
                    <Toggle 
                        label="Sincronizar Hist√≥rico Completo" 
                        checked={config.syncHistory} 
                        onChange={v=>setConfig({...config, syncHistory:v})} 
                    />
                </div>
                <button 
                    onClick={save} 
                    className="mt-6 bg-green-600 text-white px-6 py-3 rounded-lg font-bold w-full hover:bg-green-700 transition shadow-md flex items-center justify-center gap-2"
                >
                    <i className="ph-bold ph-floppy-disk text-xl"></i>
                    Salvar Altera√ß√µes
                </button>
            </div>
        );
    };

    const EventsPage = ({ apiKey }) => {
        const [webhookURL, setWebhookURL] = useState('');
        const [webhookEnabled, setWebhookEnabled] = useState(false);
        const [websocketEnabled, setWebsocketEnabled] = useState(false);
        const [saving, setSaving] = useState(false);

        // Carrega configura√ß√µes salvas
        useEffect(() => {
            const saved = localStorage.getItem('nexus_webhook_config');
            if(saved) {
                const config = JSON.parse(saved);
                setWebhookURL(config.url || '');
                setWebhookEnabled(config.enabled || false);
                setWebsocketEnabled(config.websocket || false);
            }
        }, []);

        const saveWebhook = async () => {
            if(webhookEnabled && !webhookURL.trim()) {
                NotificationManager.show("Digite uma URL v√°lida para o webhook", "error");
                return;
            }

            setSaving(true);
            try {
                const config = {
                    url: webhookURL,
                    enabled: webhookEnabled,
                    websocket: websocketEnabled
                };

                // Salva localmente
                localStorage.setItem('nexus_webhook_config', JSON.stringify(config));

                // Envia para o backend (voc√™ pode implementar um endpoint real depois)
                await fetch(`${API_URL}/settings/webhook/save`, { 
                    method: 'POST',
                    headers: { 
                        'apikey': apiKey,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(config)
                }).catch(() => {}); // Ignora erro se endpoint n√£o existir ainda

                NotificationManager.show("Webhook configurado com sucesso!", "success");
            } catch(e) {
                NotificationManager.show("Erro ao salvar webhook", "error");
            } finally {
                setSaving(false);
            }
        };

        return (
            <div className="bg-white dark:bg-dark-panel p-6 rounded-xl shadow fade-in">
                <h3 className="text-lg font-bold mb-4 text-purple-600 flex items-center gap-2">
                    <i className="ph-fill ph-broadcast text-2xl"></i> 
                    Webhooks & Eventos
                </h3>
                
                <div className="mb-4">
                    <label className="text-xs font-bold uppercase text-gray-500 dark:text-gray-400 block mb-2">
                        URL do Webhook
                    </label>
                    <input 
                        type="url" 
                        value={webhookURL}
                        onChange={(e) => setWebhookURL(e.target.value)}
                        className="w-full p-3 border rounded-lg dark:bg-gray-800 dark:border-gray-600 dark:text-white focus:ring-2 focus:ring-purple-500 focus:outline-none" 
                        placeholder="https://seu-sistema.com/webhook" 
                    />
                    <p className="text-xs text-gray-500 mt-1">
                        Cole aqui a URL que receber√° os eventos do WhatsApp
                    </p>
                </div>

                <div className="space-y-3 mb-4">
                    <Toggle 
                        label="Ativar Webhook" 
                        checked={webhookEnabled} 
                        onChange={setWebhookEnabled} 
                    />
                    <Toggle 
                        label="Ativar WebSocket (Tempo Real)" 
                        checked={websocketEnabled} 
                        onChange={setWebsocketEnabled} 
                    />
                </div>

                <button 
                    onClick={saveWebhook}
                    disabled={saving}
                    className="w-full bg-purple-600 text-white px-6 py-3 rounded-lg font-bold hover:bg-purple-700 transition disabled:opacity-50 flex items-center justify-center gap-2"
                >
                    {saving ? (
                        <>
                            <i className="ph-bold ph-circle-notch animate-spin"></i>
                            Salvando...
                        </>
                    ) : (
                        <>
                            <i className="ph-bold ph-floppy-disk"></i>
                            Salvar Webhook
                        </>
                    )}
                </button>

                {/* Logs de eventos */}
                <div className="mt-6 p-4 bg-gray-50 dark:bg-gray-800 rounded-lg border dark:border-gray-700">
                    <h4 className="text-sm font-bold mb-2 dark:text-white">Status do Webhook</h4>
                    <div className="flex items-center gap-2">
                        <div className={`w-3 h-3 rounded-full ${webhookEnabled && webhookURL ? 'bg-green-500' : 'bg-red-500'}`}></div>
                        <span className="text-sm text-gray-600 dark:text-gray-300">
                            {webhookEnabled && webhookURL ? 'Ativo e configurado' : 'Inativo'}
                        </span>
                    </div>
                </div>
            </div>
        );
    };

    const IntegrationsPage = () => {
        const [selectedIntegration, setSelectedIntegration] = useState(null);
        const [integrations, setIntegrations] = useState({
            typebot: { enabled: false, url: '', config: '' },
            chatwoot: { enabled: false, accountId: '', token: '', url: '' },
            openai: { enabled: false, apiKey: '', model: 'gpt-4' },
            n8n: { enabled: false, webhookUrl: '' },
            dify: { enabled: false, apiKey: '', url: '' },
            flowise: { enabled: false, apiKey: '', url: '' }
        });

        useEffect(() => {
            const saved = localStorage.getItem('nexus_integrations');
            if(saved) {
                setIntegrations(JSON.parse(saved));
            }
        }, []);

        const openIntegrationModal = (integration) => {
            setSelectedIntegration(integration);
        };

        const closeModal = () => {
            setSelectedIntegration(null);
        };

        const saveIntegration = (name, config) => {
            const updated = {
                ...integrations,
                [name]: config
            };
            setIntegrations(updated);
            localStorage.setItem('nexus_integrations', JSON.stringify(updated));
            NotificationManager.show(`${name.toUpperCase()} configurado com sucesso!`, "success");
            closeModal();
        };

        const integrationsList = [
            { name: 'typebot', icon: 'ü§ñ', title: 'Typebot', description: 'Chatbot inteligente' },
            { name: 'chatwoot', icon: 'üí¨', title: 'Chatwoot', description: 'Atendimento multicanal' },
            { name: 'openai', icon: 'üß†', title: 'OpenAI', description: 'Intelig√™ncia artificial' },
            { name: 'n8n', icon: '‚ö°', title: 'n8n', description: 'Automa√ß√£o de workflows' },
            { name: 'dify', icon: 'üöÄ', title: 'Dify', description: 'LLM Application' },
            { name: 'flowise', icon: 'üåä', title: 'Flowise', description: 'LLM Orchestration' }
        ];

        return (
            <>
                <div className="grid grid-cols-1 md:grid-cols-3 gap-4 fade-in">
                    {integrationsList.map(int => (
                        <div 
                            key={int.name} 
                            onClick={() => openIntegrationModal(int.name)}
                            className="bg-white dark:bg-dark-panel p-6 rounded-xl shadow border border-gray-200 dark:border-gray-700 hover:border-green-500 hover:shadow-lg transition cursor-pointer group"
                        >
                            <div className="flex justify-between items-start mb-3">
                                <div className="text-4xl">{int.icon}</div>
                                <div className={`w-3 h-3 rounded-full ${integrations[int.name]?.enabled ? 'bg-green-500' : 'bg-red-500'}`}></div>
                            </div>
                            <h4 className="font-bold text-lg dark:text-white mb-1">{int.title}</h4>
                            <p className="text-xs text-gray-500 mb-3">{int.description}</p>
                            <div className="flex items-center gap-2 text-green-600 group-hover:text-green-700 font-medium text-sm">
                                <i className="ph-bold ph-gear"></i>
                                <span>Configurar</span>
                            </div>
                        </div>
                    ))}
                </div>

                {/* Modal de Configura√ß√£o */}
                {selectedIntegration && (
                    <Modal 
                        isOpen={true} 
                        title={`Configurar ${selectedIntegration.toUpperCase()}`} 
                        onClose={closeModal}
                    >
                        <IntegrationConfig 
                            name={selectedIntegration}
                            config={integrations[selectedIntegration]}
                            onSave={saveIntegration}
                            onClose={closeModal}
                        />
                    </Modal>
                )}
            </>
        );
    };

    // Componente de Configura√ß√£o Individual
    const IntegrationConfig = ({ name, config, onSave, onClose }) => {
        const [formData, setFormData] = useState(config);

        const handleSave = () => {
            if(formData.enabled) {
                // Valida√ß√µes b√°sicas
                if(name === 'openai' && !formData.apiKey) {
                    NotificationManager.show("API Key √© obrigat√≥ria", "error");
                    return;
                }
                if(name === 'chatwoot' && (!formData.accountId || !formData.token)) {
                    NotificationManager.show("Account ID e Token s√£o obrigat√≥rios", "error");
                    return;
                }
            }
            onSave(name, formData);
        };

        const renderFields = () => {
            switch(name) {
                case 'typebot':
                    return (
                        <>
                            <input
                                type="url"
                                placeholder="URL do Typebot"
                                value={formData.url || ''}
                                onChange={(e) => setFormData({...formData, url: e.target.value})}
                                className="w-full p-3 border rounded mb-3 dark:bg-gray-700 dark:text-white"
                            />
                            <input
                                type="text"
                                placeholder="ID da Configura√ß√£o"
                                value={formData.config || ''}
                                onChange={(e) => setFormData({...formData, config: e.target.value})}
                                className="w-full p-3 border rounded mb-3 dark:bg-gray-700 dark:text-white"
                            />
                        </>
                    );
                case 'chatwoot':
                    return (
                        <>
                            <input
                                type="url"
                                placeholder="URL do Chatwoot"
                                value={formData.url || ''}
                                onChange={(e) => setFormData({...formData, url: e.target.value})}
                                className="w-full p-3 border rounded mb-3 dark:bg-gray-700 dark:text-white"
                            />
                            <input
                                type="text"
                                placeholder="Account ID"
                                value={formData.accountId || ''}
                                onChange={(e) => setFormData({...formData, accountId: e.target.value})}
                                className="w-full p-3 border rounded mb-3 dark:bg-gray-700 dark:text-white"
                            />
                            <input
                                type="password"
                                placeholder="Token de Acesso"
                                value={formData.token || ''}
                                onChange={(e) => setFormData({...formData, token: e.target.value})}
                                className="w-full p-3 border rounded mb-3 dark:bg-gray-700 dark:text-white"
                            />
                        </>
                    );
                case 'openai':
                    return (
                        <>
                            <input
                                type="password"
                                placeholder="API Key do OpenAI"
                                value={formData.apiKey || ''}
                                onChange={(e) => setFormData({...formData, apiKey: e.target.value})}
                                className="w-full p-3 border rounded mb-3 dark:bg-gray-700 dark:text-white"
                            />
                            <select
                                value={formData.model || 'gpt-4'}
                                onChange={(e) => setFormData({...formData, model: e.target.value})}
                                className="w-full p-3 border rounded mb-3 dark:bg-gray-700 dark:text-white"
                            >
                                <option value="gpt-4">GPT-4</option>
                                <option value="gpt-4-turbo">GPT-4 Turbo</option>
                                <option value="gpt-3.5-turbo">GPT-3.5 Turbo</option>
                            </select>
                        </>
                    );
                case 'n8n':
                    return (
                        <input
                            type="url"
                            placeholder="Webhook URL do n8n"
                            value={formData.webhookUrl || ''}
                            onChange={(e) => setFormData({...formData, webhookUrl: e.target.value})}
                            className="w-full p-3 border rounded mb-3 dark:bg-gray-700 dark:text-white"
                        />
                    );
                case 'dify':
                case 'flowise':
                    return (
                        <>
                            <input
                                type="url"
                                placeholder={`URL do ${name}`}
                                value={formData.url || ''}
                                onChange={(e) => setFormData({...formData, url: e.target.value})}
                                className="w-full p-3 border rounded mb-3 dark:bg-gray-700 dark:text-white"
                            />
                            <input
                                type="password"
                                placeholder="API Key"
                                value={formData.apiKey || ''}
                                onChange={(e) => setFormData({...formData, apiKey: e.target.value})}
                                className="w-full p-3 border rounded mb-3 dark:bg-gray-700 dark:text-white"
                            />
                        </>
                    );
                default:
                    return null;
            }
        };

        return (
            <div>
                <div className="mb-4">
                    <Toggle 
                        label="Ativar Integra√ß√£o" 
                        checked={formData.enabled || false} 
                        onChange={(v) => setFormData({...formData, enabled: v})} 
                    />
                </div>

                {formData.enabled && (
                    <div className="mb-4">
                        {renderFields()}
                    </div>
                )}

                <div className="flex gap-2">
                    <button 
                        onClick={handleSave}
                        className="flex-1 bg-green-600 text-white py-2 rounded font-bold hover:bg-green-700"
                    >
                        Salvar
                    </button>
                    <button 
                        onClick={onClose}
                        className="px-6 bg-gray-200 dark:bg-gray-700 py-2 rounded font-bold hover:bg-gray-300 dark:hover:bg-gray-600"
                    >
                        Cancelar
                    </button>
                </div>
            </div>
        );
    };

    const ApiKeysPage = ({ apiKey, onLogout }) => {
        const [keys, setKeys] = useState([]);
        const [showCreateModal, setShowCreateModal] = useState(false);
        const [newKeyName, setNewKeyName] = useState('');
        const [newKeyExpiry, setNewKeyExpiry] = useState('never');
        const [generatedKey, setGeneratedKey] = useState(null);

        useEffect(() => {
            loadKeys();
        }, []);

        const loadKeys = () => {
            const saved = localStorage.getItem('nexus_api_keys');
            if(saved) {
                setKeys(JSON.parse(saved));
            } else {
                // Adiciona a key padr√£o
                const defaultKey = {
                    id: generateUUID(),
                    key: '8msyqcp4o7065sz1nxdg8y69kp7gduijvb0zptz867',
                    name: 'Chave Master (Padr√£o)',
                    created: Date.now(),
                    expiry: null,
                    active: true,
                    isDefault: true
                };
                setKeys([defaultKey]);
                localStorage.setItem('nexus_api_keys', JSON.stringify([defaultKey]));
            }
        };

        const createNewKey = () => {
            if(!newKeyName.trim()) {
                NotificationManager.show("Digite um nome para a chave", "error");
                return;
            }

            const newKey = {
                id: generateUUID(),
                key: generateUUID() + generateUUID().replace(/-/g, ''), // Key longa
                name: newKeyName,
                created: Date.now(),
                expiry: newKeyExpiry === 'never' ? null : Date.now() + (parseInt(newKeyExpiry) * 24 * 60 * 60 * 1000),
                active: true,
                isDefault: false
            };

            const updatedKeys = [...keys, newKey];
            setKeys(updatedKeys);
            localStorage.setItem('nexus_api_keys', JSON.stringify(updatedKeys));
            
            setGeneratedKey(newKey);
            setNewKeyName('');
            setNewKeyExpiry('never');
            setShowCreateModal(false);
            
            NotificationManager.show("Nova API Key gerada com sucesso!", "success");
        };

        const toggleKeyStatus = (id) => {
            const updatedKeys = keys.map(k => 
                k.id === id ? {...k, active: !k.active} : k
            );
            setKeys(updatedKeys);
            localStorage.setItem('nexus_api_keys', JSON.stringify(updatedKeys));
            NotificationManager.show("Status da chave atualizado", "success");
        };

        const deleteKey = (id) => {
            const key = keys.find(k => k.id === id);
            if(key.isDefault) {
                NotificationManager.show("N√£o √© poss√≠vel excluir a chave master", "error");
                return;
            }
            
            if(!confirm(`Deseja realmente excluir a chave "${key.name}"?\n\nEsta a√ß√£o n√£o pode ser desfeita!`)) return;
            
            const updatedKeys = keys.filter(k => k.id !== id);
            setKeys(updatedKeys);
            localStorage.setItem('nexus_api_keys', JSON.stringify(updatedKeys));
            NotificationManager.show("API Key exclu√≠da", "success");
        };

        const copyKey = (key) => {
            navigator.clipboard.writeText(key);
            NotificationManager.show("Chave copiada para a √°rea de transfer√™ncia!", "success");
        };

        const isExpired = (expiry) => {
            return expiry && expiry < Date.now();
        };

        return (
            <div className="fade-in space-y-6">
                {/* Header */}
                <div className="flex justify-between items-center">
                    <div>
                        <h2 className="text-2xl font-bold dark:text-white">Gerenciamento de API Keys</h2>
                        <p className="text-sm text-gray-500 mt-1">Crie e gerencie chaves de acesso para seus clientes</p>
                    </div>
                    <button
                        onClick={() => setShowCreateModal(true)}
                        className="bg-green-600 text-white px-6 py-3 rounded-lg font-bold hover:bg-green-700 transition flex items-center gap-2"
                    >
                        <i className="ph-bold ph-plus text-xl"></i>
                        Nova API Key
                    </button>
                </div>

                {/* Stats */}
                <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
                    <div className="bg-white dark:bg-dark-panel p-4 rounded-xl shadow-sm border dark:border-gray-700">
                        <p className="text-sm text-gray-500 mb-1">Total de Chaves</p>
                        <p className="text-3xl font-bold dark:text-white">{keys.length}</p>
                    </div>
                    <div className="bg-white dark:bg-dark-panel p-4 rounded-xl shadow-sm border dark:border-gray-700">
                        <p className="text-sm text-gray-500 mb-1">Ativas</p>
                        <p className="text-3xl font-bold text-green-600">{keys.filter(k => k.active && !isExpired(k.expiry)).length}</p>
                    </div>
                    <div className="bg-white dark:bg-dark-panel p-4 rounded-xl shadow-sm border dark:border-gray-700">
                        <p className="text-sm text-gray-500 mb-1">Inativas</p>
                        <p className="text-3xl font-bold text-gray-400">{keys.filter(k => !k.active).length}</p>
                    </div>
                    <div className="bg-white dark:bg-dark-panel p-4 rounded-xl shadow-sm border dark:border-gray-700">
                        <p className="text-sm text-gray-500 mb-1">Expiradas</p>
                        <p className="text-3xl font-bold text-red-600">{keys.filter(k => isExpired(k.expiry)).length}</p>
                    </div>
                </div>

                {/* Lista de Keys */}
                <div className="bg-white dark:bg-dark-panel rounded-xl shadow-sm border dark:border-gray-700 overflow-hidden">
                    <table className="w-full">
                        <thead className="bg-gray-50 dark:bg-gray-800 border-b dark:border-gray-700">
                            <tr>
                                <th className="text-left p-4 text-sm font-bold text-gray-600 dark:text-gray-300">Nome</th>
                                <th className="text-left p-4 text-sm font-bold text-gray-600 dark:text-gray-300">API Key</th>
                                <th className="text-left p-4 text-sm font-bold text-gray-600 dark:text-gray-300">Criada em</th>
                                <th className="text-left p-4 text-sm font-bold text-gray-600 dark:text-gray-300">Expira em</th>
                                <th className="text-left p-4 text-sm font-bold text-gray-600 dark:text-gray-300">Status</th>
                                <th className="text-right p-4 text-sm font-bold text-gray-600 dark:text-gray-300">A√ß√µes</th>
                            </tr>
                        </thead>
                        <tbody>
                            {keys.map(key => (
                                <tr key={key.id} className="border-b dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-800">
                                    <td className="p-4">
                                        <div className="flex items-center gap-2">
                                            <span className="font-medium dark:text-white">{key.name}</span>
                                            {key.isDefault && (
                                                <span className="bg-blue-100 text-blue-800 text-xs px-2 py-1 rounded">Master</span>
                                            )}
                                        </div>
                                    </td>
                                    <td className="p-4">
                                        <div className="flex items-center gap-2">
                                            <code className="text-xs bg-gray-100 dark:bg-gray-700 px-2 py-1 rounded">
                                                {key.key.substring(0, 20)}...
                                            </code>
                                            <button
                                                onClick={() => copyKey(key.key)}
                                                className="text-gray-400 hover:text-green-600"
                                            >
                                                <i className="ph-bold ph-copy"></i>
                                            </button>
                                        </div>
                                    </td>
                                    <td className="p-4 text-sm text-gray-600 dark:text-gray-400">
                                        {new Date(key.created).toLocaleDateString('pt-BR')}
                                    </td>
                                    <td className="p-4 text-sm text-gray-600 dark:text-gray-400">
                                        {key.expiry ? (
                                            <span className={isExpired(key.expiry) ? 'text-red-600 font-bold' : ''}>
                                                {new Date(key.expiry).toLocaleDateString('pt-BR')}
                                            </span>
                                        ) : (
                                            <span className="text-green-600">Nunca</span>
                                        )}
                                    </td>
                                    <td className="p-4">
                                        {isExpired(key.expiry) ? (
                                            <span className="bg-red-100 text-red-800 text-xs px-3 py-1 rounded-full">Expirada</span>
                                        ) : key.active ? (
                                            <span className="bg-green-100 text-green-800 text-xs px-3 py-1 rounded-full">Ativa</span>
                                        ) : (
                                            <span className="bg-gray-100 text-gray-800 text-xs px-3 py-1 rounded-full">Inativa</span>
                                        )}
                                    </td>
                                    <td className="p-4">
                                        <div className="flex justify-end gap-2">
                                            <button
                                                onClick={() => toggleKeyStatus(key.id)}
                                                className={`p-2 rounded hover:bg-gray-100 dark:hover:bg-gray-700 ${key.active ? 'text-orange-600' : 'text-green-600'}`}
                                                title={key.active ? 'Desativar' : 'Ativar'}
                                            >
                                                <i className={`ph-bold ${key.active ? 'ph-pause' : 'ph-play'}`}></i>
                                            </button>
                                            {!key.isDefault && (
                                                <button
                                                    onClick={() => deleteKey(key.id)}
                                                    className="p-2 rounded hover:bg-gray-100 dark:hover:bg-gray-700 text-red-600"
                                                    title="Excluir"
                                                >
                                                    <i className="ph-bold ph-trash"></i>
                                                </button>
                                            )}
                                        </div>
                                    </td>
                                </tr>
                            ))}
                        </tbody>
                    </table>
                </div>

                {/* Modal de Criar Nova Key */}
                <Modal isOpen={showCreateModal} title="Criar Nova API Key" onClose={() => setShowCreateModal(false)}>
                    <div className="space-y-4">
                        <div>
                            <label className="text-sm font-bold text-gray-600 dark:text-gray-300 block mb-2">
                                Nome da Chave
                            </label>
                            <input
                                type="text"
                                value={newKeyName}
                                onChange={(e) => setNewKeyName(e.target.value)}
                                placeholder="Ex: Cliente XYZ, Produ√ß√£o, Desenvolvimento..."
                                className="w-full p-3 border rounded dark:bg-gray-700 dark:text-white"
                            />
                        </div>

                        <div>
                            <label className="text-sm font-bold text-gray-600 dark:text-gray-300 block mb-2">
                                Validade
                            </label>
                            <select
                                value={newKeyExpiry}
                                onChange={(e) => setNewKeyExpiry(e.target.value)}
                                className="w-full p-3 border rounded dark:bg-gray-700 dark:text-white"
                            >
                                <option value="never">Nunca expira</option>
                                <option value="30">30 dias</option>
                                <option value="90">90 dias</option>
                                <option value="180">180 dias</option>
                                <option value="365">1 ano</option>
                            </select>
                        </div>

                        <button
                            onClick={createNewKey}
                            className="w-full bg-green-600 text-white py-3 rounded font-bold hover:bg-green-700"
                        >
                            Gerar API Key
                        </button>
                    </div>
                </Modal>

                {/* Modal de Key Gerada */}
                <Modal 
                    isOpen={!!generatedKey} 
                    title="‚úÖ API Key Gerada com Sucesso!" 
                    onClose={() => setGeneratedKey(null)}
                >
                    <div className="space-y-4">
                        <div className="bg-yellow-50 dark:bg-yellow-900/20 border border-yellow-200 dark:border-yellow-800 rounded-lg p-4">
                            <p className="text-sm text-yellow-800 dark:text-yellow-200">
                                ‚ö†Ô∏è <strong>IMPORTANTE:</strong> Copie esta chave agora! Por seguran√ßa, ela n√£o ser√° exibida novamente.
                            </p>
                        </div>

                        <div>
                            <label className="text-sm font-bold text-gray-600 dark:text-gray-300 block mb-2">
                                Nome
                            </label>
                            <p className="text-lg font-bold dark:text-white">{generatedKey?.name}</p>
                        </div>

                        <div>
                            <label className="text-sm font-bold text-gray-600 dark:text-gray-300 block mb-2">
                                API Key
                            </label>
                            <div className="flex gap-2">
                                <code className="flex-1 bg-gray-100 dark:bg-gray-800 p-3 rounded text-sm break-all">
                                    {generatedKey?.key}
                                </code>
                                <button
                                    onClick={() => copyKey(generatedKey?.key)}
                                    className="bg-green-600 text-white px-4 rounded hover:bg-green-700"
                                >
                                    <i className="ph-bold ph-copy"></i>
                                </button>
                            </div>
                        </div>

                        <button
                            onClick={() => setGeneratedKey(null)}
                            className="w-full bg-gray-600 text-white py-3 rounded font-bold hover:bg-gray-700"
                        >
                            Fechar
                        </button>
                    </div>
                </Modal>
            </div>
        );
    };

    const ChatPage = ({ apiKey, instances }) => {
        const [contacts, setContacts] = useState([]);
        const [activeChat, setActiveChat] = useState(null);
        const [filter, setFilter] = useState('all');
        const [selectedInstance, setSelectedInstance] = useState(null);
        const [searchQuery, setSearchQuery] = useState('');
        const [messageText, setMessageText] = useState('');
        const [sending, setSending] = useState(false);
        const [messages, setMessages] = useState([]);
        const messagesEndRef = useRef(null);

        const loadContacts = async (instName) => {
            if(!instName) return;
            setSelectedInstance(instName);
            setActiveChat(null); // Limpa chat ativo
            
            try {
                const res = await fetch(`${API_URL}/chat/${instName}/contacts`, { 
                    headers: { 'apikey': apiKey } 
                });
                const data = await res.json();
                const sortedContacts = Array.isArray(data) ? data.sort((a,b)=>a.name.localeCompare(b.name)) : [];
                setContacts(sortedContacts);
                NotificationManager.show(`${sortedContacts.length} contatos carregados`, "success");
            } catch(e) {
                NotificationManager.show("Erro ao carregar contatos", "error");
                setContacts([]);
            }
        };

        const searchContacts = async () => {
            if(!selectedInstance || !searchQuery.trim()) {
                NotificationManager.show("Digite algo para buscar", "info");
                return;
            }
            
            try {
                const res = await fetch(`${API_URL}/chat/${selectedInstance}/search?q=${encodeURIComponent(searchQuery)}`, {
                    headers: { 'apikey': apiKey }
                });
                const data = await res.json();
                setContacts(Array.isArray(data) ? data : []);
                NotificationManager.show(`${data.length || 0} resultados encontrados`, "success");
            } catch(e) {
                NotificationManager.show("Erro na busca", "error");
            }
        };

        // üî• Carregar mensagens do contato selecionado
        const loadMessages = async (jid) => {
            try {
                const res = await fetch(`${API_URL}/messages/${selectedInstance}/${jid}`, {
                    headers: { 'apikey': apiKey }
                });
                const data = await res.json();

                // Normaliza formato para frontend
                const msgs = data.map(m => ({
                    id: m.key?.id,
                    fromMe: m.key?.fromMe,
                    text: m.message?.conversation || m.message?.extendedTextMessage?.text || "(mensagem)",
                    timestamp: (m.messageTimestamp || Date.now()) * 1000
                }));

                setMessages(msgs);

                // Scroll autom√°tico para √∫ltima mensagem
                setTimeout(() => messagesEndRef.current?.scrollIntoView({ behavior: 'smooth' }), 200);
                
            } catch (e) {
                NotificationManager.show("Erro ao carregar mensagens", "error");
            }
        };

        // üî• selectChat atualizado para carregar hist√≥rico automaticamente
        const selectChat = (contact) => {
            setActiveChat(contact);
            setMessages([]);

            // JID completo
            const jid = contact.jid.includes("@") ? contact.jid : contact.jid + "@s.whatsapp.net";

            loadMessages(jid); // üî• carrega hist√≥rico automaticamente
        };

        // üî• Atualiza√ß√£o autom√°tica quando novas mensagens chegam (polling a cada 4s)
        useEffect(() => {
            if(!activeChat || !selectedInstance) return;

            const interval = setInterval(() => {
                const jid = activeChat.jid.includes("@") ? activeChat.jid : activeChat.jid + "@s.whatsapp.net";
                loadMessages(jid);
            }, 4000);

            return () => clearInterval(interval);
        }, [activeChat, selectedInstance]);

        const sendMessage = async () => {
            if(!activeChat || !messageText.trim() || !selectedInstance) {
                NotificationManager.show("Selecione um contato e digite uma mensagem", "error");
                return;
            }
            
            setSending(true);
            try {
                // Remove o @s.whatsapp.net ou @g.us se existir
                const cleanNumber = activeChat.jid.split('@')[0];
                
                const res = await fetch(`${API_URL}/message/${selectedInstance}/text`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'apikey': apiKey
                    },
                    body: JSON.stringify({
                        number: cleanNumber,
                        text: messageText
                    })
                });
                
                const data = await res.json();
                
                if(data.status === 'success') {
                    // Adiciona mensagem enviada na tela
                    const newMsg = {
                        id: Date.now(),
                        text: messageText,
                        fromMe: true,
                        timestamp: Date.now()
                    };
                    setMessages([...messages, newMsg]);
                    setMessageText('');
                    NotificationManager.show("Mensagem enviada!", "success");
                    
                    // Scroll para o final
                    setTimeout(() => messagesEndRef.current?.scrollIntoView({ behavior: 'smooth' }), 100);
                } else {
                    NotificationManager.show(data.error || "Erro ao enviar", "error");
                }
            } catch(e) {
                console.error("Erro:", e);
                NotificationManager.show("Falha no envio: " + e.message, "error");
            } finally {
                setSending(false);
            }
        };

        const handleKeyPress = (e) => {
            if(e.key === 'Enter' && !e.shiftKey && !sending) {
                e.preventDefault();
                sendMessage();
            }
        };

        const filtered = contacts.filter(c => {
            if(filter === 'all') return true;
            if(filter === 'group') return c.is_group;
            return !c.is_group;
        });

        return (
            <div className="flex h-[calc(100vh-8rem)] bg-white dark:bg-dark-panel rounded-xl shadow border border-gray-200 dark:border-gray-700 overflow-hidden fade-in">
                {/* SIDEBAR DE CONTATOS */}
                <div className="w-1/3 border-r dark:border-gray-700 flex flex-col">
                    <div className="p-4 border-b dark:border-gray-700 bg-gray-50 dark:bg-gray-800">
                        <select 
                            onChange={(e) => loadContacts(e.target.value)} 
                            className="w-full p-2 mb-3 rounded border dark:bg-gray-700 dark:text-white"
                            value={selectedInstance || ''}
                        >
                            <option value="">Selecione Inst√¢ncia...</option>
                            {instances.filter(i => i.status === 'connected').map(i => (
                                <option key={i.name} value={i.name}>{i.name} ({i.pushName || 'Sem nome'})</option>
                            ))}
                        </select>
                        
                        {/* BUSCA */}
                        <div className="flex gap-2 mb-3">
                            <input
                                type="text"
                                value={searchQuery}
                                onChange={(e) => setSearchQuery(e.target.value)}
                                onKeyPress={(e) => e.key === 'Enter' && searchContacts()}
                                placeholder="Buscar contato..."
                                className="flex-1 p-2 text-sm rounded border dark:bg-gray-700 dark:text-white"
                            />
                            <button
                                onClick={searchContacts}
                                className="bg-green-600 text-white px-3 rounded hover:bg-green-700"
                                disabled={!selectedInstance}
                            >
                                <i className="ph-bold ph-magnifying-glass"></i>
                            </button>
                        </div>

                        {/* FILTROS */}
                        <div className="flex gap-2">
                            {['all', 'user', 'group'].map(t => (
                                <button 
                                    key={t} 
                                    onClick={()=>setFilter(t)} 
                                    className={`flex-1 text-xs py-1 rounded capitalize ${filter===t?'bg-green-100 text-green-800 font-bold dark:bg-green-900/30':'bg-gray-200 dark:bg-gray-700 dark:text-white'}`}
                                >
                                    {t === 'all' ? 'Todos' : t === 'user' ? 'Usu√°rios' : 'Grupos'}
                                </button>
                            ))}
                        </div>
                    </div>
                    
                    {/* LISTA DE CONTATOS */}
                    <div className="flex-1 overflow-y-auto">
                        {filtered.length === 0 ? (
                            <div className="flex flex-col items-center justify-center h-full text-gray-400">
                                <i className="ph-bold ph-address-book text-6xl mb-4"></i>
                                <p className="text-sm">Nenhum contato encontrado</p>
                            </div>
                        ) : (
                            filtered.map(c => (
                                <div 
                                    key={c.jid} 
                                    onClick={() => selectChat(c)} 
                                    className={`p-3 flex items-center gap-3 cursor-pointer hover:bg-gray-100 dark:hover:bg-gray-700 border-b dark:border-gray-800 transition ${activeChat?.jid===c.jid?'bg-green-50 dark:bg-green-900/20 border-l-4 border-l-green-600':''}`}
                                >
                                    {c.avatar ? (
                                        <img 
                                            src={c.avatar} 
                                            className="w-12 h-12 rounded-full object-cover" 
                                            alt={c.name}
                                            onError={(e) => {
                                                e.target.onerror = null;
                                                e.target.src = '';
                                                e.target.style.display = 'none';
                                                e.target.nextSibling.style.display = 'flex';
                                            }}
                                        />
                                    ) : null}
                                    <div 
                                        className="w-12 h-12 rounded-full bg-gradient-to-br from-green-400 to-green-600 flex items-center justify-center text-white text-xl font-bold"
                                        style={{display: c.avatar ? 'none' : 'flex'}}
                                    >
                                        {c.is_group ? 'üë•' : c.name.charAt(0).toUpperCase()}
                                    </div>
                                    <div className="flex-1 min-w-0">
                                        <h4 className="font-bold text-sm truncate dark:text-white">{c.name}</h4>
                                        <p className="text-xs text-gray-500 truncate">{c.jid.split('@')[0]}</p>
                                    </div>
                                </div>
                            ))
                        )}
                    </div>
                </div>
                
                {/* √ÅREA DE CHAT */}
                <div className="flex-1 flex flex-col bg-[#efeae2] dark:bg-[#0b141a]">
                    {activeChat ? (
                        <>
                            {/* CABE√áALHO DO CHAT */}
                            <div className="p-4 bg-gray-100 dark:bg-gray-800 flex items-center gap-3 border-b dark:border-gray-700 shadow-sm">
                                {activeChat.avatar ? (
                                    <img 
                                        src={activeChat.avatar} 
                                        className="w-12 h-12 rounded-full object-cover" 
                                        alt={activeChat.name}
                                        onError={(e) => {
                                            e.target.onerror = null;
                                            e.target.src = '';
                                            e.target.style.display = 'none';
                                            e.target.nextSibling.style.display = 'flex';
                                        }}
                                    />
                                ) : null}
                                <div 
                                    className="w-12 h-12 rounded-full bg-gradient-to-br from-green-400 to-green-600 flex items-center justify-center text-white text-xl font-bold"
                                    style={{display: activeChat.avatar ? 'none' : 'flex'}}
                                >
                                    {activeChat.is_group ? 'üë•' : activeChat.name.charAt(0).toUpperCase()}
                                </div>
                                <div className="flex-1">
                                    <h3 className="font-bold dark:text-white">{activeChat.name}</h3>
                                    <p className="text-xs text-gray-500">{activeChat.jid}</p>
                                </div>
                                <button 
                                    onClick={() => setActiveChat(null)}
                                    className="text-gray-400 hover:text-red-500"
                                    title="Fechar chat"
                                >
                                    <i className="ph-bold ph-x text-xl"></i>
                                </button>
                            </div>
                            
                            {/* MENSAGENS */}
                            <div className="flex-1 p-4 overflow-y-auto">
                                {messages.length === 0 ? (
                                    <div className="flex justify-center">
                                        <span className="text-xs bg-white/50 dark:bg-black/30 px-4 py-2 rounded-full">
                                            üîí Suas mensagens s√£o protegidas com criptografia de ponta a ponta
                                        </span>
                                    </div>
                                ) : (
                                    messages.map((msg, idx) => (
                                        <div 
                                            key={idx} 
                                            className={`flex mb-3 ${msg.fromMe ? 'justify-end' : 'justify-start'}`}
                                        >
                                            <div 
                                                className={`max-w-[70%] rounded-lg px-4 py-2 ${
                                                    msg.fromMe 
                                                        ? 'bg-green-100 dark:bg-green-900/30' 
                                                        : 'bg-white dark:bg-gray-800'
                                                }`}
                                            >
                                                <p className="text-sm dark:text-white">{msg.text}</p>
                                                <span className="text-[10px] text-gray-500 mt-1 block">
                                                    {new Date(msg.timestamp).toLocaleTimeString('pt-BR', {hour: '2-digit', minute:'2-digit'})}
                                                </span>
                                            </div>
                                        </div>
                                    ))
                                )}
                                <div ref={messagesEndRef} />
                            </div>
                            
                            {/* INPUT DE MENSAGEM */}
                            <div className="p-3 bg-gray-100 dark:bg-gray-800 flex gap-2 border-t dark:border-gray-700">
                                <input 
                                    value={messageText}
                                    onChange={(e) => setMessageText(e.target.value)}
                                    onKeyPress={handleKeyPress}
                                    className="flex-1 p-3 rounded-lg border dark:bg-gray-700 dark:text-white dark:border-gray-600 focus:outline-none focus:ring-2 focus:ring-green-500" 
                                    placeholder="Digite uma mensagem..." 
                                    disabled={sending}
                                />
                                <button 
                                    onClick={sendMessage}
                                    disabled={sending || !messageText.trim()}
                                    className="bg-green-600 text-white px-4 rounded-lg hover:bg-green-700 disabled:opacity-50 disabled:cursor-not-allowed transition flex items-center gap-2"
                                >
                                    {sending ? (
                                        <>
                                            <i className="ph-bold ph-circle-notch animate-spin"></i>
                                            <span className="text-sm">Enviando...</span>
                                        </>
                                    ) : (
                                        <>
                                            <i className="ph-fill ph-paper-plane-right text-xl"></i>
                                            <span className="text-sm">Enviar</span>
                                        </>
                                    )}
                                </button>
                            </div>
                        </>
                    ) : (
                        <div className="flex-1 flex items-center justify-center text-gray-400">
                            <div className="text-center">
                                <i className="ph-bold ph-chat-text text-8xl mb-4 text-gray-300"></i>
                                <p className="text-lg font-medium">Selecione um contato para come√ßar</p>
                                <p className="text-sm text-gray-400 mt-2">Escolha um contato da lista ao lado</p>
                            </div>
                        </div>
                    )}
                </div>
            </div>
        );
    };

    const InstanceCard = ({ inst, onConnect, onAction, onUpdateInfo }) => {
        const [loading, setLoading] = useState(false);
        const [showKey, setShowKey] = useState(false);
        const handle = async (act) => { 
            setLoading(true); 
            await onAction(act, inst.name); 
            setLoading(false); 
        };

        useEffect(() => { 
            if(inst.status === 'connected' && (!inst.jid || !inst.stats)) {
                onUpdateInfo(inst.name); 
            }
        }, [inst.status]);

        return (
            <div className="bg-white dark:bg-dark-panel rounded-xl shadow-sm border border-gray-200 dark:border-gray-700 p-5 fade-in">
                <div className="flex items-center gap-4 mb-4">
                    <div className="relative">
                        {inst.avatar ? (
                            <img 
                                src={inst.avatar} 
                                className="w-16 h-16 rounded-full border-2 border-gray-100 object-cover" 
                                onError={(e)=>{e.target.src='https://via.placeholder.com/150?text=WA'}} 
                            />
                        ) : (
                            <div className="w-16 h-16 rounded-full bg-gray-100 dark:bg-gray-800 flex items-center justify-center text-3xl">
                                {inst.status==='connected'?'ü§ñ':'üîå'}
                            </div>
                        )}
                        <div className={`absolute bottom-0 right-0 w-4 h-4 rounded-full border-2 border-white ${inst.status==='connected'?'bg-green-500':'bg-red-500'}`}></div>
                    </div>
                    <div className="flex-1 min-w-0">
                        <h3 className="font-bold text-lg dark:text-white truncate">{inst.pushName || inst.name}</h3>
                        <p className="text-xs text-gray-500 bg-gray-100 dark:bg-gray-800 px-2 py-0.5 rounded mt-1 inline-block truncate max-w-full">
                            {inst.jid ? inst.jid.split('@')[0] : "Desconectado"}
                        </p>
                    </div>
                </div>

                {inst.status === 'connected' && (
                    <div className="grid grid-cols-3 gap-2 mb-4">
                        <div className="bg-blue-50 dark:bg-blue-900/20 p-2 rounded text-center border border-blue-100 dark:border-blue-800">
                            <p className="text-[10px] font-bold text-blue-600">CONTATOS</p>
                            <p className="text-lg font-bold text-blue-800 dark:text-blue-300">{inst.stats?.contacts || 0}</p>
                        </div>
                        <div className="bg-purple-50 dark:bg-purple-900/20 p-2 rounded text-center border border-purple-100 dark:border-purple-800">
                            <p className="text-[10px] font-bold text-purple-600">GRUPOS</p>
                            <p className="text-lg font-bold text-purple-800 dark:text-purple-300">{inst.stats?.groups || 0}</p>
                        </div>
                        <div className="bg-green-50 dark:bg-green-900/20 p-2 rounded text-center border border-green-100 dark:border-green-800">
                            <p className="text-[10px] font-bold text-green-600">ENVIADAS</p>
                            <p className="text-lg font-bold text-green-800 dark:text-green-300">{inst.stats?.messagesSent || 0}</p>
                        </div>
                    </div>
                )}

                <div className="bg-gray-50 dark:bg-gray-800/50 p-2 rounded mb-4 border border-gray-200 dark:border-gray-700 flex justify-between items-center">
                    <code className="text-xs font-mono text-gray-600 dark:text-gray-300 truncate w-32">
                        {showKey ? inst.apiKey : "‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"}
                    </code>
                    <div className="flex gap-2">
                        <button 
                            onClick={()=>setShowKey(!showKey)} 
                            className="text-gray-400 hover:text-green-500"
                        >
                            <i className={`ph-bold ${showKey?'ph-eye-slash':'ph-eye'}`}></i>
                        </button>
                        <button 
                            onClick={()=>{
                                navigator.clipboard.writeText(inst.apiKey); 
                                NotificationManager.show("API Key copiada!", "success");
                            }} 
                            className="text-gray-400 hover:text-blue-500"
                        >
                            <i className="ph-bold ph-copy"></i>
                        </button>
                    </div>
                </div>

                <div className="grid grid-cols-4 gap-2">
                    {inst.status !== 'connected' ? (
                        <button 
                            onClick={() => onConnect(inst.name)} 
                            disabled={loading} 
                            className="col-span-3 bg-green-600 hover:bg-green-700 text-white py-2 rounded-lg text-sm font-bold flex items-center justify-center gap-2 transition shadow-sm disabled:opacity-50"
                        >
                            {loading ? <i className="ph ph-spinner animate-spin"></i> : <i className="ph-bold ph-qr-code"></i>}
                            Conectar
                        </button>
                    ) : (
                        <>
                            <button 
                                onClick={() => handle('refresh')} 
                                title="Sincronizar" 
                                className="bg-blue-50 hover:bg-blue-100 text-blue-600 py-2 rounded-lg flex justify-center"
                            >
                                <i className={`ph-bold ph-arrows-clockwise ${loading?'animate-spin':''}`}></i>
                            </button>
                            <button 
                                onClick={() => handle('restart')} 
                                title="Reiniciar" 
                                className="bg-orange-50 hover:bg-orange-100 text-orange-600 py-2 rounded-lg flex justify-center"
                            >
                                <i className="ph-bold ph-lightning"></i>
                            </button>
                            <button 
                                onClick={() => handle('logout')} 
                                title="Desconectar" 
                                className="bg-red-50 hover:bg-red-100 text-red-600 py-2 rounded-lg flex justify-center"
                            >
                                <i className="ph-bold ph-plug"></i>
                            </button>
                        </>
                    )}
                    <button 
                        onClick={() => handle('delete')} 
                        title="Excluir" 
                        className="bg-gray-100 hover:bg-red-500 hover:text-white text-gray-500 py-2 rounded-lg flex justify-center transition"
                    >
                        <i className="ph-bold ph-trash"></i>
                    </button>
                </div>
            </div>
        );
    };

    const Dashboard = ({ apiKey, onLogout }) => {
        const [activeTab, setActiveTab] = useState('instances');
        const [instances, setInstances] = useState([]);
        const [modals, setModals] = useState({});
        const [qrData, setQrData] = useState(null);
        const [pairCode, setPairCode] = useState(null);
        const [phoneInput, setPhoneInput] = useState("");
        const [selectedInst, setSelectedInst] = useState(null);
        const [darkMode, setDarkMode] = useState(false);

        useEffect(() => {
            const saved = localStorage.getItem('nexus_instances_v13');
            if (saved) setInstances(JSON.parse(saved));
            if(darkMode) document.documentElement.classList.add('dark'); 
            else document.documentElement.classList.remove('dark');
        }, [darkMode]);

        useEffect(() => {
    if(instances.length === 0) return;
    
    const checkConnectionStatus = async () => {
        const connectedInstances = instances.filter(i => i.status === 'connected');
        
        for(const inst of connectedInstances) {
            try {
                const res = await fetch(`${API_URL}/instance/${inst.name}/info`, { 
                    headers: { 'apikey': apiKey } 
                });
                
                if(!res.ok) {
                    // Erro HTTP, marca como offline
                    setInstances(prev => prev.map(i => 
                        i.name === inst.name ? {...i, status: 'disconnected', jid: null, avatar: null} : i
                    ));
                    NotificationManager.show(`‚ö†Ô∏è ${inst.name} foi desconectado!`, "error");
                    continue;
                }
                
                const data = await res.json();
                
                // Se retornar erro ou disconnected, atualiza
                if(data.status === 'disconnected' || data.error) {
                    setInstances(prev => prev.map(i => 
                        i.name === inst.name ? {...i, status: 'disconnected', jid: null, avatar: null} : i
                    ));
                    NotificationManager.show(`‚ö†Ô∏è ${inst.name} foi desconectado!`, "error");
                }
            } catch(e) {
                // Se der erro na requisi√ß√£o, marca como offline
                console.error(`Erro ao verificar ${inst.name}:`, e);
                setInstances(prev => prev.map(i => 
                    i.name === inst.name ? {...i, status: 'disconnected'} : i
                ));
            }
        }
    };

    // Primeira verifica√ß√£o imediata
    checkConnectionStatus();
    
    // Verifica a cada 10 segundos
    const interval = setInterval(checkConnectionStatus, 10000);
    
    return () => clearInterval(interval);
}, [apiKey]); // ‚úÖ REMOVIDO 'instances' das depend√™ncias!

        const saveInstances = (v) => { 
            setInstances(v); 
            localStorage.setItem('nexus_instances_v13', JSON.stringify(v)); 
        };
        
        const openModal = (t, i) => { 
            setSelectedInst(i); 
            setModals({...modals, [t]: true}); 
        };
        
        const closeModal = (t) => setModals({...modals, [t]: false});

        const addInstance = () => {
            const name = document.getElementById('newInstName').value.replace(/\s+/g, '');
            if(name && !instances.find(i=>i.name===name)) {
                saveInstances([...instances, {
                    name, 
                    apiKey: generateUUID(), 
                    status: 'disconnected', 
                    stats: {contacts:0, groups:0, messagesSent:0}
                }]);
                closeModal('add');
                NotificationManager.show(`Inst√¢ncia "${name}" criada!`, "success");
            } else {
                NotificationManager.show("Nome inv√°lido ou j√° existe", "error");
            }
        };

        const connectInstance = async (name) => {
            saveInstances(instances.map(i => i.name === name ? {...i, status: 'connecting'} : i));
            NotificationManager.show(`Conectando ${name}...`, "info");
            
            try {
                const res = await fetch(`${API_URL}/instance/${name}/connect`, { 
                    method: 'POST', 
                    headers: { 'apikey': apiKey } 
                });
                const data = await res.json();
                
                if (data.status === 'success') {
                    if (data.qrcode) {
                        setQrData(data.qrcode);
                        openModal('qr', { name });
                        
                        const poll = setInterval(async () => {
                            const iRes = await fetch(`${API_URL}/instance/${name}/info`, { 
                                headers: { 'apikey': apiKey } 
                            });
                            const info = await iRes.json();
                            
                            if(info.status === 'connected') { 
                                clearInterval(poll); 
                                closeModal('qr'); 
                                updateInfo(name); 
                                NotificationManager.show(`${name} conectado!`, "success");
                            }
                        }, 2000);
                    } else {
                        updateInfo(name);
                    }
                } else {
                    NotificationManager.show(data.message || "Erro ao conectar", "error");
                    saveInstances(instances.map(i => i.name === name ? {...i, status: 'disconnected'} : i));
                }
            } catch(e) {
                NotificationManager.show("Erro de conex√£o", "error");
                saveInstances(instances.map(i => i.name === name ? {...i, status: 'disconnected'} : i));
            }
        };

        const updateInfo = async (name) => {
    try {
        const res = await fetch(`${API_URL}/instance/${name}/info`, { 
            headers: { 'apikey': apiKey }  // ‚úÖ ADICIONE ESTA LINHA
        });
        const data = await res.json();
        
        if (data.status === 'connected') {
            saveInstances(instances.map(i => i.name === name ? {
                ...i, 
                status: 'connected', 
                jid: data.jid, 
                avatar: data.avatar, 
                pushName: data.name, 
                stats: {
                    contacts: data.contacts, 
                    groups: data.groups,
                    messagesSent: data.messagesSent || 0
                }
            } : i));
        } else {
            // ‚úÖ ADICIONE: Se n√£o conectado, marca como disconnected
            saveInstances(instances.map(i => i.name === name ? {
                ...i,
                status: 'disconnected'
            } : i));
        }
    } catch(e) {
        console.error("Erro ao atualizar info:", e);
        // ‚úÖ ADICIONE: Em caso de erro, marca como disconnected
        saveInstances(instances.map(i => i.name === name ? {
            ...i,
            status: 'disconnected'
        } : i));
    }
};

        const handleAction = async (action, name) => {
            if(action === 'delete') {
                if(!confirm('‚ö†Ô∏è Tem certeza que deseja EXCLUIR esta inst√¢ncia?\n\nEsta a√ß√£o n√£o pode ser desfeita!')) return;
                
                NotificationManager.show("Excluindo inst√¢ncia...", "info");
                await fetch(`${API_URL}/instance/${name}/logout`, { 
                    method: 'POST', 
                    headers: { 'apikey': apiKey } 
                });
                saveInstances(instances.filter(i => i.name !== name));
                NotificationManager.show("Inst√¢ncia exclu√≠da com sucesso!", "success");
                
            } else if(action === 'logout') {
                if(!confirm('‚ö†Ô∏è Deseja realmente DESCONECTAR esta inst√¢ncia?\n\nVoc√™ precisar√° escanear o QR Code novamente.')) return;
                
                NotificationManager.show("Desconectando...", "info");
                await fetch(`${API_URL}/instance/${name}/logout`, { 
                    method: 'POST', 
                    headers: { 'apikey': apiKey } 
                });
                saveInstances(instances.map(i => i.name === name ? {...i, status: 'disconnected', jid: null, avatar: null} : i));
                NotificationManager.show(`${name} desconectado com sucesso!`, "success");
                
            } else if(action === 'refresh') {
                NotificationManager.show("Sincronizando...", "info");
                await updateInfo(name);
                NotificationManager.show("Sincroniza√ß√£o conclu√≠da!", "success");
                
            } else if(action === 'restart') {
                if(!confirm('‚ö†Ô∏è Deseja REINICIAR esta inst√¢ncia?')) return;
                
                NotificationManager.show("Reiniciando...", "info");
                saveInstances(instances.map(i => i.name === name ? {...i, status: 'disconnected'} : i));
                setTimeout(() => connectInstance(name), 1500);
            }
        };

        const handlePairing = async () => {
            const res = await fetch(`${API_URL}/instance/${selectedInst.name}/pair`, {
                method: 'POST', 
                headers: { 
                    'apikey': apiKey, 
                    'Content-Type': 'application/json' 
                },
                body: JSON.stringify({ phone: phoneInput })
            });
            const data = await res.json();
            
            if(data.code) {
                setPairCode(data.code);
                NotificationManager.show("C√≥digo gerado!", "success");
            } else {
                NotificationManager.show(data.error, "error");
            }
        };

        const totalContacts = instances.reduce((acc, curr) => acc + (curr.stats?.contacts || 0), 0);
        const totalGroups = instances.reduce((acc, curr) => acc + (curr.stats?.groups || 0), 0);
        const totalMessages = instances.reduce((acc, curr) => acc + (curr.stats?.messagesSent || 0), 0);
        const onlineCount = instances.filter(i => i.status === 'connected').length;

        return (
            <div className="flex h-screen overflow-hidden font-sans bg-gray-50 dark:bg-[#0c1317]">
                {/* Modais */}
                <Modal isOpen={modals.add} title="Nova Inst√¢ncia" onClose={() => closeModal('add')}>
                    <input 
                        id="newInstName" 
                        type="text" 
                        className="w-full p-3 border rounded mb-4 dark:bg-gray-700 dark:text-white" 
                        placeholder="Nome da inst√¢ncia" 
                    />
                    <button 
                        onClick={addInstance} 
                        className="w-full bg-green-600 text-white py-2 rounded font-bold hover:bg-green-700"
                    >
                        Criar Inst√¢ncia
                    </button>
                </Modal>

                <Modal isOpen={modals.qr} title="Escanear QR Code" onClose={() => closeModal('qr')}>
                    <div className="flex justify-center mb-4">
                        <img src={qrData} className="w-64 border-4 border-white shadow-lg rounded" alt="QR Code" />
                    </div>
                    <p className="text-center text-sm text-gray-500 mb-4">
                        Abra o WhatsApp e escaneie o c√≥digo
                    </p>
                    <div className="text-center">
                        <button 
                            onClick={() => { closeModal('qr'); openModal('pair', selectedInst); }} 
                            className="text-blue-500 font-bold hover:underline"
                        >
                            Usar C√≥digo de Pareamento
                        </button>
                    </div>
                </Modal>

                <Modal isOpen={modals.pair} title="Pareamento" onClose={() => closeModal('pair')}>
                    {!pairCode ? (
                        <>
                            <input 
                                value={phoneInput} 
                                onChange={e=>setPhoneInput(e.target.value)} 
                                className="w-full p-3 border rounded mb-4 dark:bg-gray-700 dark:text-white" 
                                placeholder="5511999999999" 
                            />
                            <button 
                                onClick={handlePairing} 
                                className="w-full bg-green-600 text-white py-2 rounded font-bold hover:bg-green-700"
                            >
                                Gerar C√≥digo
                            </button>
                        </>
                    ) : (
                        <div className="text-center">
                            <p className="text-sm text-gray-500 mb-4">Digite este c√≥digo no WhatsApp:</p>
                            <div className="text-3xl font-mono font-bold p-4 bg-gray-100 dark:bg-gray-800 rounded">
                                {pairCode}
                            </div>
                        </div>
                    )}
                </Modal>

                {/* Sidebar */}
                <div className="w-72 bg-white dark:bg-dark-panel border-r border-gray-200 dark:border-gray-800 flex flex-col z-10">
                    <div className="p-6 flex items-center gap-3">
                        <div className="w-10 h-10 bg-green-600 rounded flex items-center justify-center text-white">
                            <i className="ph-bold ph-whatsapp-logo text-2xl"></i>
                        </div>
                        <span className="font-bold text-xl dark:text-white">NexusWA</span>
                    </div>

                    <nav className="p-4 space-y-2 flex-1">
                        {['instances', 'chat', 'apikeys', 'settings', 'events', 'integrations'].map(tab => (
                            <button 
                                key={tab} 
                                onClick={() => setActiveTab(tab)} 
                                className={`w-full flex items-center gap-3 px-4 py-3 rounded-lg capitalize transition ${activeTab===tab?'bg-green-50 text-green-700 font-bold dark:bg-green-900/20':'text-gray-500 hover:bg-gray-100 dark:hover:bg-gray-800'}`}
                            >
                                <i className={`ph-bold ${
                                    tab==='instances'?'ph-squares-four':
                                    tab==='chat'?'ph-chat-circle-text':
                                    tab==='apikeys'?'ph-key':
                                    tab==='settings'?'ph-gear':
                                    tab==='events'?'ph-broadcast':'ph-plugs'
                                } text-lg`}></i> 
                                {tab === 'apikeys' ? 'API Keys' : tab}
                            </button>
                        ))}
                    </nav>
                    
                    <div className="p-4 border-t dark:border-gray-800">
                        <div className="flex justify-between mb-4">
                            <span className="dark:text-gray-300 text-sm">Modo Escuro</span>
                            <button 
                                onClick={() => setDarkMode(!darkMode)} 
                                className={`w-10 h-5 rounded-full relative transition ${darkMode ? 'bg-green-600' : 'bg-gray-300'}`}
                            >
                                <div className={`w-3 h-3 bg-white rounded absolute top-1 transition-all ${darkMode?'left-6':'left-1'}`}></div>
                            </button>
                        </div>
                        <button 
                            onClick={onLogout} 
                            className="w-full text-red-500 font-bold text-sm hover:bg-red-50 dark:hover:bg-red-900/20 py-2 rounded transition"
                        >
                            Sair
                        </button>
                    </div>
                </div>

                <div className="flex-1 overflow-y-auto p-8">
                    <div className="max-w-7xl mx-auto pb-10">
                        {activeTab === 'instances' && (
                            <div className="fade-in space-y-8">
                                {/* STATS */}
                                <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
                                    <div className="bg-white dark:bg-dark-panel p-4 rounded-xl shadow-sm border dark:border-gray-700 flex items-center gap-4">
                                        <div className="w-12 h-12 rounded-full bg-green-100 text-green-600 flex items-center justify-center text-2xl">
                                            <i className="ph-fill ph-whatsapp-logo"></i>
                                        </div>
                                        <div>
                                            <p className="text-gray-500 text-xs font-bold uppercase">Inst√¢ncias</p>
                                            <h3 className="text-2xl font-bold dark:text-white">
                                                {instances.length} ({onlineCount} on)
                                            </h3>
                                        </div>
                                    </div>
                                    
                                    <div className="bg-white dark:bg-dark-panel p-4 rounded-xl shadow-sm border dark:border-gray-700 flex items-center gap-4">
                                        <div className="w-12 h-12 rounded-full bg-blue-100 text-blue-600 flex items-center justify-center text-2xl">
                                            <i className="ph-fill ph-users"></i>
                                        </div>
                                        <div>
                                            <p className="text-gray-500 text-xs font-bold uppercase">Contatos</p>
                                            <h3 className="text-2xl font-bold dark:text-white">{totalContacts}</h3>
                                        </div>
                                    </div>
                                    
                                    <div className="bg-white dark:bg-dark-panel p-4 rounded-xl shadow-sm border dark:border-gray-700 flex items-center gap-4">
                                        <div className="w-12 h-12 rounded-full bg-purple-100 text-purple-600 flex items-center justify-center text-2xl">
                                            <i className="ph-fill ph-chats-circle"></i>
                                        </div>
                                        <div>
                                            <p className="text-gray-500 text-xs font-bold uppercase">Grupos</p>
                                            <h3 className="text-2xl font-bold dark:text-white">{totalGroups}</h3>
                                        </div>
                                    </div>
                                    
                                    <div className="bg-white dark:bg-dark-panel p-4 rounded-xl shadow-sm border dark:border-gray-700 flex items-center gap-4">
                                        <div className="w-12 h-12 rounded-full bg-orange-100 text-orange-600 flex items-center justify-center text-2xl">
                                            <i className="ph-fill ph-envelope-open"></i>
                                        </div>
                                        <div>
                                            <p className="text-gray-500 text-xs font-bold uppercase">Mensagens</p>
                                            <h3 className="text-2xl font-bold dark:text-white">{totalMessages}</h3>
                                        </div>
                                    </div>
                                </div>
                                
                                {/* GRID */}
                                <div className="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6">
                                    <div 
                                        onClick={() => openModal('add')} 
                                        className="bg-white dark:bg-dark-panel border-2 border-dashed border-gray-300 dark:border-gray-600 rounded-xl p-6 flex flex-col items-center justify-center text-gray-400 hover:border-green-500 hover:text-green-500 cursor-pointer transition h-full min-h-[16rem]"
                                    >
                                        <i className="ph-bold ph-plus text-3xl"></i>
                                        <span className="mt-2 font-bold">Nova Inst√¢ncia</span>
                                    </div>
                                    
                                    {instances.map(inst => (
                                        <InstanceCard 
                                            key={inst.name} 
                                            inst={inst} 
                                            onConnect={connectInstance} 
                                            onAction={handleAction} 
                                            onUpdateInfo={updateInfo} 
                                        />
                                    ))}
                                </div>
                            </div>
                        )}
                        
                        {activeTab === 'chat' && <ChatPage apiKey={apiKey} instances={instances} />}
                        {activeTab === 'settings' && <SettingsPage apiKey={apiKey} />}
                        {activeTab === 'events' && <EventsPage apiKey={apiKey} />}
                        {activeTab === 'integrations' && <IntegrationsPage />}
                         {activeTab === 'apikeys' && <ApiKeysPage apiKey={apiKey} onLogout={onLogout} />}
                    </div>
                </div>
            </div>
        );
    };

    const LoginScreen = ({ onLogin }) => {
        const [key, setKey] = useState('');
        
        return (
            <div className="min-h-screen flex items-center justify-center bg-gray-100 dark:bg-[#0c1317]">
                <div className="bg-white dark:bg-dark-panel p-8 rounded-lg shadow-lg w-full max-w-md text-center">
                    <div className="w-16 h-16 bg-green-600 rounded-full mx-auto mb-4 flex items-center justify-center">
                        <i className="ph-bold ph-whatsapp-logo text-3xl text-white"></i>
                    </div>
                    <h2 className="text-2xl font-bold mb-6 dark:text-white">NexusWA Enterprise</h2>
                    <input 
                        type="password" 
                        onChange={e=>setKey(e.target.value)} 
                        className="w-full p-3 border rounded mb-4 dark:bg-gray-700 dark:text-white" 
                        placeholder="Chave de Acesso" 
                    />
                    <button 
                        onClick={()=>onLogin(key)} 
                        className="w-full bg-green-600 text-white py-3 rounded font-bold hover:bg-green-700 transition"
                    >
                        Entrar
                    </button>
                </div>
            </div>
        );
    };

    const App = () => {
        const [auth, setAuth] = useState(false);
        const [apiKey, setApiKey] = useState('');
        
        useEffect(() => { 
            const s = localStorage.getItem('nexus_apikey'); 
            if(s) { 
                setApiKey(s); 
                setAuth(true); 
            } 
        }, []);
        
        return (
            <>
                {auth ? (
                    <Dashboard 
                        apiKey={apiKey} 
                        onLogout={() => {
                            localStorage.removeItem('nexus_apikey'); 
                            setAuth(false);
                            NotificationManager.show("At√© logo!", "info");
                        }} 
                    />
                ) : (
                    <LoginScreen 
                        onLogin={(k) => {
                            setApiKey(k); 
                            localStorage.setItem('nexus_apikey', k); 
                            setAuth(true);
                            NotificationManager.show("Bem-vindo ao NexusWA!", "success");
                        }} 
                    />
                )}
            </>
        );
    };

    ReactDOM.createRoot(document.getElementById('root')).render(<App />);
</script>
</body>
</html>